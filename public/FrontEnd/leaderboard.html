<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Leaderboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script>!function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);}catch(e){}}();</script>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Optional: Theme icon color adaptation */
        [data-theme="light"] .nav__icon { stroke: var(--text-muted); }
        [data-theme="light"] .nav__item.active .nav__icon { stroke: var(--purple); }
        .theme-toggle-btn .theme-icon--sun { stroke: white; }
        [data-theme="light"] .theme-toggle-btn .theme-icon--sun { stroke: var(--text); }
    </style>
</head>
<body>
    <section class="app">
        <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle" aria-hidden="true" />
        <label for="sidebar-toggle" class="sidebar__hamburger" aria-label="Toggle navigation">
            <span></span><span></span><span></span>
        </label>

        <aside class="sidebar">
            <div class="sidebar__brand"><span class="logo-dot"></span><span class="brand-text">TaskTrek</span></div>
            <nav class="sidebar__nav">
                 <a href="dashboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg><span>Dashboard</span></a>
                 <a href="tasks.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Tasks</span></a>
                 <a href="shop.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12l2 6H4l2-6Z"/><path d="M4 8h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8Z"/><path d="M9 13h6"/></svg><span>Shop</span></a>
                 <a href="groups.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Groups</span></a>
                 <a href="leaderboard.html" class="nav__item active"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21V10"/><path d="M16 21V3"/><path d="M12 21v-6"/></svg><span>Leaderboard</span></a>
                 <a href="activity.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Activity</span></a>
                 <a href="team.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Team</span></a>
                 <a href="profile.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="theme-toggle">
                    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">
                        <svg class="theme-icon theme-icon--sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                        <svg class="theme-icon theme-icon--moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                </div>
                <a class="btn btn--ghost" id="logout-btn" href="#">Logout</a>
            </div>
        </aside>

        <div class="content">
            <section class="panel">
                <div class="panel__header">
                    <h2 id="leaderboard-title">Leaderboard</h2>
                    <div class="panel__actions">
                        <select class="input" style="width: auto;" onchange="filterLeaderboard(this.value)">
                            <option value="all">All Time</option>
                            <option value="month">This Month</option>
                            <option value="week">This Week</option>
                        </select>
                    </div>
                </div>
                
                <div class="leaderboard-stats">
                    <div class="stat-card">
                        <span class="stat-label">Your Rank</span>
                        <span class="stat-value" id="stat-your-rank">#?</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Your Points</span>
                        <span class="stat-value" id="stat-your-points">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Tasks Completed</span>
                        <span class="stat-value" id="stat-your-tasks">0</span>
                    </div>
                </div>

                <div class="table-wrap">
                    <table class="table leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Member</th>
                                <th>Total Points</th>
                                <th>Completed Tasks</th>
                                <th>Gold Tasks</th>
                                <th>Silver Tasks</th>
                                <th>Bronze Tasks</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <tr><td colspan="7" style="text-align: center;">Loading leaderboard...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>
    </section>

    <script src="theme.js"></script>

    <script type="module">
        import { db, auth, onAuthStateChanged, doc } from './firebase.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { collection, query, where, orderBy, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // UI Elements
        const leaderboardTableBody = document.getElementById("leaderboard-body");
        const yourRankEl = document.getElementById("stat-your-rank");
        const yourPointsEl = document.getElementById("stat-your-points");
        const yourTasksEl = document.getElementById("stat-your-tasks");
        const leaderboardTitleEl = document.getElementById("leaderboard-title");
        const logoutBtn = document.getElementById('logout-btn');
        
        // Global State
        let currentUser = null;
        let activeGroupId = null;
        let activeGroupData = null;
        let unsubscribeUserListener = null;
        let unsubscribeGroupListener = null;

        // --- Core Logic ---
        function listenForActiveGroupAndUser() {
            if (!currentUser) return;
            if (unsubscribeUserListener) unsubscribeUserListener();

            const userRef = doc(db, "users", currentUser.uid);
            unsubscribeUserListener = onSnapshot(userRef, (userDoc) => {
                if (!userDoc.exists()) { console.error("Current user document not found!"); return; }
                
                const userData = userDoc.data();
                yourPointsEl.textContent = (userData.points || 0).toLocaleString(); 

                const newActiveGroupId = userData.activeGroupId;
                if (!newActiveGroupId) {
                    leaderboardTitleEl.textContent = "Leaderboard - No Group Selected";
                    leaderboardTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Select an active group on the Groups page.</td></tr>';
                    yourRankEl.textContent = '#?'; yourTasksEl.textContent = '0';
                    if (unsubscribeGroupListener) unsubscribeGroupListener();
                    activeGroupId = null; return;
                }

                if (newActiveGroupId !== activeGroupId) {
                    activeGroupId = newActiveGroupId;
                    if (unsubscribeGroupListener) unsubscribeGroupListener();
                    
                    const groupRef = doc(db, "groups", activeGroupId);
                    unsubscribeGroupListener = onSnapshot(groupRef, (groupDoc) => {
                        if (groupDoc.exists()) {
                            activeGroupData = groupDoc.data();
                            leaderboardTitleEl.textContent = `Leaderboard - ${activeGroupData.name || 'Unnamed Group'}`;
                            // Call the function to load/render
                            loadAndRenderLeaderboard(currentUser.uid, activeGroupData.members);
                        } else {
                            leaderboardTitleEl.textContent = "Leaderboard - Group Not Found";
                            leaderboardTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading group data.</td></tr>';
                            yourRankEl.textContent = '#?'; yourTasksEl.textContent = '0';
                            activeGroupId = null;
                        }
                    }, error => console.error("Error listening to group:", error));
                }
            }, error => console.error("Error listening to user:", error));
        }

        // ✅ FIXED: loadAndRenderLeaderboard now fetches all data *before* rendering
        async function loadAndRenderLeaderboard(currentUserId, memberIds) {
            if (!memberIds || memberIds.length === 0) {
                leaderboardTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">This group has no members yet.</td></tr>';
                yourRankEl.textContent = '#?'; yourTasksEl.textContent = '0';
                return;
            }

            leaderboardTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

            // Query for member user data, sorted by points
            const membersQuery = query(
                collection(db, "users"),
                where("__name__", "in", memberIds.slice(0, 30)), // 'in' query limit
                orderBy("points", "desc")
            );
            
            try {
                const snapshot = await getDocs(membersQuery);
                if (snapshot.empty) {
                     leaderboardTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No members found.</td></tr>';
                     return;
                }

                // Create a list of promises to fetch task counts for all members
                const taskCountPromises = snapshot.docs.map(doc => fetchUserTaskCounts(doc.id));
                // Wait for ALL task count fetches to complete
                const allTaskCounts = await Promise.all(taskCountPromises);

                // Now that we have all data, clear the table and render everything
                leaderboardTableBody.innerHTML = ""; 
                
                snapshot.docs.forEach((doc, index) => {
                    const user = doc.data();
                    const taskCounts = allTaskCounts[index]; // Get the matching task count
                    const isCurrentUser = doc.id === currentUserId;
                    const rank = index + 1; // Rank is the position in the sorted list

                    if (isCurrentUser) {
                        yourRankEl.textContent = `#${rank}`; // Update user's rank stat card
                        yourTasksEl.textContent = taskCounts.total; // Update user's task stat card
                    }
                    
                    // Render the row for this user
                    renderLeaderboardRow(rank, user, doc.id, isCurrentUser, taskCounts);
                });

            } catch (error) {
                 console.error("Error loading leaderboard:", error);
                 leaderboardTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading leaderboard. Check console for index errors.</td></tr>';
            }
        }

        // Helper to fetch task counts for a specific user
        async function fetchUserTaskCounts(userId) {
            const tasksQuery = query(collection(db, "tasks"), where("assignee", "==", userId), where("status", "==", "completed"));
            const snapshot = await getDocs(tasksQuery);
            let counts = { total: snapshot.size, gold: 0, silver: 0, bronze: 0 };
            snapshot.forEach(doc => {
                const task = doc.data();
                if (task.difficulty === 'gold') counts.gold++;
                else if (task.difficulty === 'silver') counts.silver++;
                else if (task.difficulty === 'bronze') counts.bronze++;
            });
            return counts;
        }

        // Helper to render a single row in the table
        function renderLeaderboardRow(rank, userData, userId, isCurrentUser, taskCounts) {
            const row = document.createElement("tr");
            row.className = `leaderboard-row ${isCurrentUser ? 'current-user' : ''} rank-${rank <= 3 ? rank : ''}`;
            
            row.innerHTML = `
                <td><div class="rank-badge rank-${rank <= 3 ? rank : ''}">${rank}</div></td>
                <td>
                    <div class="member-info">
                        <div class="avatar" style="background-image: url(${userData.photoURL || ''})"></div>
                        <div>
                            <strong>${userData.name || 'Unnamed User'} ${isCurrentUser ? '(You)' : ''}</strong>
                            <div class="muted">@${userData.username || userData.email}</div>
                        </div>
                    </div>
                </td>
                <td><strong>${(userData.points || 0).toLocaleString()}</strong></td>
                <td>${taskCounts.total}</td>
                <td>${taskCounts.gold}</td>
                <td>${taskCounts.silver}</td>
                <td>${taskCounts.bronze}</td>
            `;
            leaderboardTableBody.appendChild(row);
        }

        // Filter Function (Placeholder for Month/Week)
        window.filterLeaderboard = (period) => {
            console.log(`Filtering leaderboard by: ${period}`);
            // This is a placeholder. For now, it just reloads "All Time"
            leaderboardTitleEl.textContent = `Leaderboard (${period === 'all' ? 'All Time' : period === 'month' ? 'This Month' : 'This Week'}) - ${activeGroupData?.name || 'Group'}`;
            if (activeGroupId && activeGroupData && currentUser) {
                loadAndRenderLeaderboard(currentUser.uid, activeGroupData.members);
            }
        };

        // --- Logout & Initialize ---
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                listenForActiveGroupAndUser();
            } else {
                window.location.href = 'auth.html';
                if (unsubscribeUserListener) unsubscribeUserListener();
                if (unsubscribeGroupListener) unsubscribeGroupListener();
            }
        });
    </script>
</body>
</html>