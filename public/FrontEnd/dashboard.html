<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script>!function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);}catch(e){}}();</script>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Optional: Ensure chart text color adapts to theme */
        [data-theme="light"] .chart-card { color: var(--text); }
        [data-theme="light"] .chart-header h3 { color: var(--text); }
        [data-theme="light"] .chart-legend .legend-item { color: var(--text-muted); }
        .theme-toggle-btn .theme-icon--sun { stroke: white; } /* Keep sun icon white */
        [data-theme="light"] .theme-toggle-btn .theme-icon--sun { stroke: var(--text); } /* Sun icon color in light mode */
    </style>
</head>
<body>
    <section class="app">
        <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle" aria-hidden="true" />
        <label for="sidebar-toggle" class="sidebar__hamburger" aria-label="Toggle navigation">
            <span></span><span></span><span></span>
        </label>

        <aside class="sidebar">
            <div class="sidebar__brand"><span class="logo-dot"></span><span class="brand-text">TaskTrek</span></div>
            <nav class="sidebar__nav">
                 <a href="dashboard.html" class="nav__item active"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg><span>Dashboard</span></a>
                 <a href="tasks.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Tasks</span></a>
                 <a href="shop.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12l2 6H4l2-6Z"/><path d="M4 8h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8Z"/><path d="M9 13h6"/></svg><span>Shop</span></a>
                 <a href="groups.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Groups</span></a>
                 <a href="leaderboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21V10"/><path d="M16 21V3"/><path d="M12 21v-6"/></svg><span>Leaderboard</span></a>
                 <a href="activity.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Activity</span></a>
                 <a href="team.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Team</span></a>
                 <a href="profile.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="theme-toggle">
                    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">
                        <svg class="theme-icon theme-icon--sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                        <svg class="theme-icon theme-icon--moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                </div>
                <a class="btn btn--ghost" id="logout-btn" href="#">Logout</a>
            </div>
        </aside>

        <div class="content">
            <section class="panel">
                <h2>Dashboard</h2>
                <div class="cards">
                    <div class="stat-card">
                        <span class="stat-label">Total Tasks (Assigned)</span>
                        <span class="stat-value" id="stat-total-tasks">0</span>
                        <div class="stat-trend" id="stat-total-trend">(Placeholder)</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">In Progress</span>
                        <span class="stat-value" id="stat-in-progress">0</span>
                        <div class="stat-trend" id="stat-due-today">(Placeholder)</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Completed (by You)</span>
                        <span class="stat-value" id="stat-completed">0</span>
                        <div class="stat-trend" id="stat-completion-rate">(Placeholder)</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Your Points</span>
                        <span class="stat-value" id="stat-points">0</span>
                        <div class="stat-trend" id="stat-rank">Rank #?</div>
                    </div>
                </div>
                
                <div class="dashboard-charts">
                    <div class="chart-card">
                        <div class="chart-header"><h3>Task Completion Trends</h3><div class="chart-period"><select class="chart-select" onchange="window.updateChart('taskChart', this.value)"><option value="week">This Week</option><option value="month" selected>This Month</option></select></div></div>
                        <div class="chart-container"><canvas id="taskChart" width="400" height="200"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header"><h3>Points Distribution</h3></div>
                        <div class="chart-container"><canvas id="pointsChart" width="300" height="300"></canvas></div>
                    </div>
                </div>

                <div class="dashboard-heatmap">
                     <div class="chart-card">
                         <div class="chart-header"><h3>Activity Heatmap (Placeholder)</h3><div class="heatmap-legend"><span>Less</span><div class="heatmap-legend-colors"><div class="heatmap-legend-item" style="background: #1f2937;"></div><div class="heatmap-legend-item" style="background: #374151;"></div><div class="heatmap-legend-item" style="background: #4b5563;"></div><div class="heatmap-legend-item" style="background: #6b7280;"></div><div class="heatmap-legend-item" style="background: #8b5cf6;"></div></div><span>More</span></div></div>
                         <div class="heatmap-container"><div id="activityHeatmap"></div></div>
                     </div>
                 </div>

                <div class="dashboard-grid" style="margin-top: 20px;">
                    <div class="dashboard-card">
                         <h3>Weekly Goals (Placeholder)</h3>
                         <div class="progress-item"><div class="progress-label"><span>Complete 5 Tasks</span><span id="goal-tasks-progress">0/5</span></div><div class="progress-bar"><div id="goal-tasks-fill" class="progress-fill" style="width: 0%;"></div></div></div>
                         <div class="progress-item"><div class="progress-label"><span>Earn 500 Points</span><span id="goal-points-progress">0/500</span></div><div class="progress-bar"><div id="goal-points-fill" class="progress-fill" style="width: 0%;"></div></div></div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3>Recent Activity</h3>
                        <ul class="feed" id="recent-activity-feed"><li>Loading...</li></ul>
                    </div>
                </div>

                <div class="dashboard-performance">
                      <div class="dashboard-card"><h3>Group Performance (Placeholder)</h3><div class="performance-metric"><div class="metric-item"><span class="metric-label">Average Completion</span><span id="group-avg-completion" class="metric-value">0%</span></div><div class="metric-item"><span class="metric-label">Active Members</span><span id="group-active-members" class="metric-value">0/0</span></div></div></div>
                 </div>
            </section>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="theme.js"></script> 
    
    <script type="module">
        // ✅ Imports - Added 'getFunctions' and 'httpsCallable'
        import { db, auth, onAuthStateChanged, formatTimeAgo, doc } from './firebase.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { collection, query, where, orderBy, limit, getDocs, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        // ✅ Import the Functions SDK
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";
    
        // UI Elements
        const stats = {
            totalTasks: document.getElementById('stat-total-tasks'),
            inProgress: document.getElementById('stat-in-progress'),
            completed: document.getElementById('stat-completed'),
            points: document.getElementById('stat-points'),
            rank: document.getElementById('stat-rank'),
            totalTrend: document.getElementById('stat-total-trend'), // Stat trend elements
            dueToday: document.getElementById('stat-due-today'),
            completionRate: document.getElementById('stat-completion-rate')
        };
        const activityFeedEl = document.getElementById('recent-activity-feed');
        const logoutBtn = document.getElementById('logout-btn');
        const goalTasksProgress = document.getElementById('goal-tasks-progress');
        const goalTasksFill = document.getElementById('goal-tasks-fill');
        const goalPointsProgress = document.getElementById('goal-points-progress');
        const goalPointsFill = document.getElementById('goal-points-fill');
        let taskChart, pointsChart; // Chart instances
    
        // ✅ Get Firebase Functions instance and reference the deployed function
        const functions = getFunctions();
        const getDashboardStats = httpsCallable(functions, 'getDashboardStats');
    
        // --- Load Basic Dynamic Data (Real-time listeners) ---
        function loadDashboardData(userId) {
            // Listen for user's points (updates the main points card)
            const userRef = doc(db, "users", userId);
            onSnapshot(userRef, (userDoc) => {
                if (userDoc.exists()) {
                    stats.points.textContent = (userDoc.data().points || 0).toLocaleString();
                }
            });
    
            // Listen for user's assigned tasks (updates task counts and completion rate)
            const tasksQuery = query(collection(db, "tasks"), where("assignee", "==", userId));
            onSnapshot(tasksQuery, (snapshot) => {
                let completedCount = 0, inProgressCount = 0;
                snapshot.forEach(doc => {
                    const task = doc.data();
                    if (task.status === "completed") completedCount++;
                    else if (task.status === "in-progress") inProgressCount++;
                });
                const totalAssigned = snapshot.size;
                stats.totalTasks.textContent = totalAssigned;
                stats.inProgress.textContent = inProgressCount;
                stats.completed.textContent = completedCount;
                const completionRate = totalAssigned > 0 ? Math.round((completedCount / totalAssigned) * 100) : 0;
                stats.completionRate.textContent = `${completionRate}% completion rate`;
    
                // Update Weekly Task Goal (Based on total completed vs. goal)
                const tasksGoal = 5; // Assuming goal is 5
                goalTasksProgress.textContent = `${completedCount}/${tasksGoal}`;
                goalTasksFill.style.width = `${Math.min(100, (completedCount / tasksGoal) * 100)}%`;
            });
    
            // Listen for GLOBAL recent activity
            const activitiesQuery = query(collection(db, "activities"), orderBy("createdAt", "desc"), limit(3));
            onSnapshot(activitiesQuery, (snapshot) => {
                activityFeedEl.innerHTML = "";
                if (snapshot.empty) activityFeedEl.innerHTML = "<li>No recent activity.</li>";
                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const dotColor = activity.type?.includes("task") ? "gold" : activity.type?.includes("reward") ? "bronze" : "purple";
                    const li = document.createElement("li");
                    li.className = "feed-item";
                    li.innerHTML = `<span class="dot dot--${dotColor}"></span><div><strong>${activity.userName || 'Someone'}</strong> ${activity.details || ''}</div><time>${formatTimeAgo(activity.createdAt)}</time>`;
                    activityFeedEl.appendChild(li);
                });
            });
        }
    
        // ✅ Function to call the Cloud Function for specific stats ---
        async function loadStatsFromFunction(userId) {
          try {
            console.log("Calling getDashboardStats function...");
            // No need to pass userId, the function gets it from the authenticated context
            const result = await getDashboardStats();
            const data = result.data; // The data returned by your function { pointsEarnedToday, userRank, tasksDueToday, tasksCompletedThisWeek }
    
            console.log("Stats received from function:", data);
    
            // Update Rank Trend
            stats.rank.textContent = data.userRank ? `Rank #${data.userRank}` : 'Rank #?';
    
            // Update Due Today Trend
            stats.dueToday.textContent = `${data.tasksDueToday || 0} due today`;
    
            // Update Weekly Points Goal (using points earned today as proxy for week)
            const pointsGoal = 500; // Assuming goal is 500
            const pointsEarned = data.pointsEarnedToday || 0;
            goalPointsProgress.textContent = `${pointsEarned}/${pointsGoal}`;
            goalPointsFill.style.width = `${Math.min(100, (pointsEarned / pointsGoal) * 100)}%`;
    
            // Note: "+X% this week" (Total Tasks Trend) is still hardcoded
    
          } catch (error) {
            console.error("Error calling getDashboardStats function:", error);
            stats.rank.textContent = 'Rank Error';
            stats.dueToday.textContent = 'Error';
          }
        }
    
        // --- Static Chart/Heatmap Initialization (Unchanged) ---
        function initializeStaticElements() { /* ... Chart/Heatmap init code ... */ }
        function generateHeatmap() { /* ... Heatmap generation code ... */ }
        window.updateChart = (chartId, period) => { /* ... Placeholder ... */ };
    
        // --- Initialize Page ---
        document.addEventListener('DOMContentLoaded', initializeStaticElements);
    
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadDashboardData(user.uid);      // Load real-time basic data
                loadStatsFromFunction(user.uid); // ✅ Call the cloud function for calculated stats
            } else {
                window.location.href = 'auth.html';
            }
        });
    
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });
    </script>
</body>
</html>