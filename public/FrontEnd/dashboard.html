<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script>!function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);}catch(e){}}();</script>
    <link rel="stylesheet" href="styles.css" />
    <style>
        [data-theme="light"] .nav__icon { stroke: var(--text-muted); }
        [data-theme="light"] .nav__item.active .nav__icon { stroke: var(--purple); }
        .theme-toggle-btn .theme-icon--sun { stroke: white; }
        [data-theme="light"] .theme-toggle-btn .theme-icon--sun { stroke: var(--text); }
    </style>
</head>
<body>
    <section class="app">

        <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle" aria-hidden="true" />
<label for="sidebar-toggle" class="sidebar__hamburger" aria-label="Toggle navigation">
    <span></span><span></span><span></span>
</label>
        <aside class="sidebar">
             <div class="sidebar__brand"><span class="logo-dot"></span><span class="brand-text">TaskTrek</span></div>
             <nav class="sidebar__nav">
                 <a href="dashboard.html" class="nav__item active"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg><span>Dashboard</span></a>
                 <a href="tasks.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Tasks</span></a>
                 <a href="shop.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12l2 6H4l2-6Z"/><path d="M4 8h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8Z"/><path d="M9 13h6"/></svg><span>Shop</span></a>
                 <a href="groups.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Groups</span></a>
                 <a href="leaderboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21V10"/><path d="M16 21V3"/><path d="M12 21v-6"/></svg><span>Leaderboard</span></a>
                 <a href="activity.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Activity</span></a>
                 <a href="team.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Team</span></a>
                 <a href="profile.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="theme-toggle"><button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme"><svg class="theme-icon theme-icon--sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><svg class="theme-icon theme-icon--moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button></div>
                <a class="btn btn--ghost" id="logout-btn" href="#">Logout</a>
            </div>
        </aside>

        <div class="content">
            <section class="panel">
                <h2>Dashboard</h2>
                <div class="panel__actions" style="margin-bottom: 16px;">
                    <button type="button" class="btn btn--primary" id="export-excel-btn" title="Download as Excel (CSV)">Export as Excel</button>
                    <button type="button" class="btn btn--secondary" id="export-word-btn" title="Download as Word document">Export as Word</button>
                </div>
                <div class="cards">
                    <div class="stat-card"><span class="stat-label">Total Tasks (Assigned)</span><span class="stat-value" id="stat-total-tasks">0</span><div class="stat-trend" id="stat-total-trend">...</div></div>
                    <div class="stat-card"><span class="stat-label">In Progress</span><span class="stat-value" id="stat-in-progress">0</span><div class="stat-trend" id="stat-due-today">...</div></div>
                    <div class="stat-card"><span class="stat-label">Completed (by You)</span><span class="stat-value" id="stat-completed">0</span><div class="stat-trend" id="stat-completion-rate">...</div></div>
                    <div class="stat-card"><span class="stat-label">Your Points</span><span class="stat-value" id="stat-points">0</span><div class="stat-trend" id="stat-rank">...</div></div>
                </div>
                
                <div class="dashboard-charts">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3>Task Completion Trends</h3>
                            <div class="chart-period">
                                <select class="chart-select" onchange="window.updateChart('taskChart', this.value)">
                                    <option value="week">This Week</option>
                                    <option value="month" selected>This Month</option>
                                </select>
                            </div>
                        </div>
                        <div class="chart-container"><canvas id="taskChart" width="400" height="200"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header"><h3>Group Points Distribution</h3></div>
                        <div class="chart-container"><canvas id="pointsChart" width="300" height="300"></canvas></div>
                    </div>
                </div>

                <div class="dashboard-grid" style="margin-top: 20px;">
                    <div class="dashboard-card">
                        <h3>Weekly Goals</h3>
                        <div class="progress-item"><div class="progress-label"><span>Complete 5 Tasks (This Week)</span><span id="goal-tasks-progress">0/5</span></div><div class="progress-bar"><div id="goal-tasks-fill" class="progress-fill" style="width: 0%;"></div></div></div>
                        <div class="progress-item"><div class="progress-label"><span>Earn 500 Points (This Week)</span><span id="goal-points-progress">0/500</span></div><div class="progress-bar"><div id="goal-points-fill" class="progress-fill" style="width: 0%;"></div></div></div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Recent Activity</h3>
                        <ul class="feed" id="recent-activity-feed"><li>Loading...</li></ul>
                    </div>
                </div>

                <div class="dashboard-heatmap" style="display:none;">...</div>
                <div class="dashboard-performance" style="display:none;">...</div>
            </section>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="theme.js"></script>
    
    <script type="module">
        import { db, auth, onAuthStateChanged, formatTimeAgo, doc } from './firebase.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { collection, query, orderBy, limit, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";
    
        // UI Elements
        const stats = {
            totalTasks: document.getElementById('stat-total-tasks'),
            inProgress: document.getElementById('stat-in-progress'),
            completed: document.getElementById('stat-completed'),
            points: document.getElementById('stat-points'),
            rank: document.getElementById('stat-rank'),
            totalTrend: document.getElementById('stat-total-trend'), // ✅ This is the one
            dueToday: document.getElementById('stat-due-today'),
            completionRate: document.getElementById('stat-completion-rate')
        };
        const activityFeedEl = document.getElementById('recent-activity-feed');
        const logoutBtn = document.getElementById('logout-btn');
        const goalTasksProgress = document.getElementById('goal-tasks-progress');
        const goalTasksFill = document.getElementById('goal-tasks-fill');
        const goalPointsProgress = document.getElementById('goal-points-progress');
        const goalPointsFill = document.getElementById('goal-points-fill');
        
        let taskChart, pointsChart; // Chart instances
        let currentUserId = null; // Store current user ID
        let lastDashboardData = null; // For export (stats + chart data)
    
        // Cloud Function Reference
        const functions = getFunctions();
        const getDashboardData = httpsCallable(functions, 'getDashboardData');
    
        // --- Chart.js Global Config ---
        const getChartTextColor = () => getComputedStyle(document.body).getPropertyValue('--text-muted') || '#b6aee6';
        const getChartGridColor = () => getComputedStyle(document.body).getPropertyValue('--outline') || '#2a244b';
        Chart.defaults.font.color = getChartTextColor();
        Chart.defaults.color = getChartTextColor();
        
        // --- Initialize Charts (Called once) ---
        function initializeCharts() {
            const taskCtx = document.getElementById('taskChart')?.getContext('2d');
            if (taskCtx) {
                taskChart = new Chart(taskCtx, { 
                    type: 'line', data: { labels: [], datasets: [] }, 
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: getChartTextColor() }}}, scales: { x: { grid: { color: getChartGridColor() }, ticks: { color: getChartTextColor() }}, y: { grid: { color: getChartGridColor() }, ticks: { color: getChartTextColor() }}} }
                });
            }
            const pointsCtx = document.getElementById('pointsChart')?.getContext('2d');
            if (pointsCtx) {
                pointsChart = new Chart(pointsCtx, { 
                    type: 'doughnut', data: { labels: [], datasets: [] }, 
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: getChartTextColor() }}}} 
                });
            }
        }
        
        // --- Function to call the Cloud Function ---
        async function loadDynamicData(period = 'month') {
            if (!currentUserId) return;
            console.log(`Calling getDashboardData function for period: ${period}...`);
            try {
                const result = await getDashboardData({ period: period });
                const data = result.data;
                lastDashboardData = data; // Store for export
                console.log("Stats received from function:", data);
    
                // Populate Stats Cards
                stats.totalTasks.textContent = data.tasksTotal || 0;
                stats.inProgress.textContent = data.tasksInProgress || 0;
                stats.completed.textContent = data.tasksCompleted || 0;
                stats.points.textContent = (data.userPoints || 0).toLocaleString();
                
                // Populate Stat Trends
                stats.rank.textContent = data.userRank ? `Rank #${data.userRank}` : 'Rank #?';
                stats.dueToday.textContent = `${data.tasksDueToday || 0} due today`;
                stats.completionRate.textContent = `${data.completionRate || 0}% completion rate`;
                
                // ✅ FIXED: Use the dynamic trend from the function
                stats.totalTrend.textContent = data.totalTasksTrend || "N/A";
    
                // Populate Weekly Goals
                const tasksGoal = 5; const pointsGoal = 500;
                const tasksCompletedWeek = data.tasksCompletedThisWeek || 0;
                const pointsEarnedWeek = data.pointsThisWeek || 0;
                goalTasksProgress.textContent = `${tasksCompletedWeek}/${tasksGoal}`;
                goalTasksFill.style.width = `${Math.min(100, (tasksCompletedWeek / tasksGoal) * 100)}%`;
                goalPointsProgress.textContent = `${pointsEarnedWeek}/${pointsGoal}`;
                goalPointsFill.style.width = `${Math.min(100, (pointsEarnedWeek / pointsGoal) * 100)}%`;
                
                // Update Charts
                if (taskChart && data.taskChartData) {
                    taskChart.data = data.taskChartData;
                    updateChartColors(taskChart);
                }
                if (pointsChart && data.pointsChartData) {
                    pointsChart.data = data.pointsChartData;
                    updateChartColors(pointsChart);
                }
            } catch (error) {
                console.error("Error calling getDashboardData function:", error);
                stats.rank.textContent = 'Rank Error';
                stats.dueToday.textContent = 'Error';
                stats.totalTrend.textContent = 'Error'; // Show error
            }
        }
        
        // --- Listen for GLOBAL recent activity (Lightweight) ---
        function listenForRecentActivity() {
            const activitiesQuery = query(collection(db, "activities"), orderBy("createdAt", "desc"), limit(3));
            onSnapshot(activitiesQuery, (snapshot) => {
                activityFeedEl.innerHTML = "";
                if (snapshot.empty) activityFeedEl.innerHTML = "<li>No recent activity.</li>";
                snapshot.forEach(doc => {
                    const activity = doc.data();
                    const dotColor = activity.type?.includes("task") ? "gold" : activity.type?.includes("reward") ? "bronze" : "purple";
                    const li = document.createElement("li");
                    li.className = "feed-item";
                    li.innerHTML = `<span class="dot dot--${dotColor}"></span><div><strong>${activity.userName || 'Someone'}</strong> ${activity.details || ''}</div><time>${formatTimeAgo(activity.createdAt)}</time>`;
                    activityFeedEl.appendChild(li);
                });
            });
        }
        
        // --- updateChart now calls loadDynamicData ---
        window.updateChart = (chartId, period) => {
            if (chartId === 'taskChart') {
                loadDynamicData(period); // Reload all data for the new period
            }
        };
    
        // --- Helper to update chart colors on theme change ---
        function updateChartColors(chart) {
            if (!chart) return;
            const textColor = getChartTextColor();
            const gridColor = getChartGridColor();
            if (chart.options.plugins && chart.options.plugins.legend) {
                chart.options.plugins.legend.labels.color = textColor;
            }
            if (chart.options.scales && chart.options.scales.x) { 
                chart.options.scales.x.ticks.color = textColor;
                chart.options.scales.x.grid.color = gridColor;
            }
            if (chart.options.scales && chart.options.scales.y) {
                chart.options.scales.y.ticks.color = textColor;
                chart.options.scales.y.grid.color = gridColor;
            }
            chart.update();
        }
        
        // --- Initialize Page ---
        document.addEventListener('DOMContentLoaded', initializeCharts);
        window.addEventListener('themeChanged', () => {
            updateChartColors(taskChart);
            updateChartColors(pointsChart);
        });
    
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                loadDynamicData('month'); // Call Cloud Function on load
                listenForRecentActivity(); // Start live listener
            } else {
                window.location.href = 'auth.html';
            }
        });
    
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        // --- Export Dashboard Data ---
        function exportAsExcel() {
            if (!lastDashboardData) {
                alert('No dashboard data to export. Wait for the dashboard to load.');
                return;
            }
            const rows = [
                ['TaskTrek Dashboard Export', ''],
                ['Exported', new Date().toLocaleString()],
                [],
                ['Metric', 'Value'],
                ['Total Tasks (Assigned)', lastDashboardData.tasksTotal ?? 0],
                ['In Progress', lastDashboardData.tasksInProgress ?? 0],
                ['Completed (by You)', lastDashboardData.tasksCompleted ?? 0],
                ['Your Points', lastDashboardData.userPoints ?? 0],
                ['Rank', lastDashboardData.userRank ? `#${lastDashboardData.userRank}` : 'N/A'],
                ['Tasks Due Today', lastDashboardData.tasksDueToday ?? 0],
                ['Completion Rate (%)', lastDashboardData.completionRate ?? 0],
                ['Points This Week', lastDashboardData.pointsThisWeek ?? 0],
                ['Tasks Completed This Week', lastDashboardData.tasksCompletedThisWeek ?? 0],
                ['Total Tasks Trend', lastDashboardData.totalTasksTrend ?? 'N/A'],
                [],
                ['Task Completion Trends (Chart)', ''],
                ...(lastDashboardData.taskChartData?.labels?.length ? [
                    ['Period', ...lastDashboardData.taskChartData.labels],
                    ['Tasks Completed', ...(lastDashboardData.taskChartData.datasets?.[0]?.data ?? [])],
                    ['Tasks Created', ...(lastDashboardData.taskChartData.datasets?.[1]?.data ?? [])]
                ] : []),
                [],
                ['Group Points Distribution', ''],
                ...(lastDashboardData.pointsChartData?.labels?.length ? [
                    ['Member', ...lastDashboardData.pointsChartData.labels],
                    ['Points', ...(lastDashboardData.pointsChartData.datasets?.[0]?.data ?? [])]
                ] : [])
            ];
            const csv = rows.map(row => row.map(cell => {
                const s = String(cell ?? '');
                return /[,"\n\r]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
            }).join(',')).join('\r\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `TaskTrek-Dashboard-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function exportAsWord() {
            if (!lastDashboardData) {
                alert('No dashboard data to export. Wait for the dashboard to load.');
                return;
            }
            const html = `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word">
<head><meta charset="utf-8"><title>TaskTrek Dashboard Export</title></head>
<body>
<h1>TaskTrek Dashboard Export</h1>
<p>Exported: ${new Date().toLocaleString()}</p>
<table border="1" cellpadding="6" cellspacing="0">
<tr><th>Metric</th><th>Value</th></tr>
<tr><td>Total Tasks (Assigned)</td><td>${lastDashboardData.tasksTotal ?? 0}</td></tr>
<tr><td>In Progress</td><td>${lastDashboardData.tasksInProgress ?? 0}</td></tr>
<tr><td>Completed (by You)</td><td>${lastDashboardData.tasksCompleted ?? 0}</td></tr>
<tr><td>Your Points</td><td>${lastDashboardData.userPoints ?? 0}</td></tr>
<tr><td>Rank</td><td>${lastDashboardData.userRank ? '#' + lastDashboardData.userRank : 'N/A'}</td></tr>
<tr><td>Tasks Due Today</td><td>${lastDashboardData.tasksDueToday ?? 0}</td></tr>
<tr><td>Completion Rate (%)</td><td>${lastDashboardData.completionRate ?? 0}</td></tr>
<tr><td>Points This Week</td><td>${lastDashboardData.pointsThisWeek ?? 0}</td></tr>
<tr><td>Tasks Completed This Week</td><td>${lastDashboardData.tasksCompletedThisWeek ?? 0}</td></tr>
<tr><td>Total Tasks Trend</td><td>${lastDashboardData.totalTasksTrend ?? 'N/A'}</td></tr>
</table>
${lastDashboardData.taskChartData?.labels?.length ? `
<h2>Task Completion Trends</h2>
<table border="1" cellpadding="6" cellspacing="0">
<tr><th>Period</th>${(lastDashboardData.taskChartData.labels).map(l => `<th>${l}</th>`).join('')}</tr>
<tr><td>Tasks Completed</td>${(lastDashboardData.taskChartData.datasets?.[0]?.data ?? []).map(d => `<td>${d}</td>`).join('')}</tr>
<tr><td>Tasks Created</td>${(lastDashboardData.taskChartData.datasets?.[1]?.data ?? []).map(d => `<td>${d}</td>`).join('')}</tr>
</table>
` : ''}
${lastDashboardData.pointsChartData?.labels?.length ? `
<h2>Group Points Distribution</h2>
<table border="1" cellpadding="6" cellspacing="0">
<tr><th>Member</th>${(lastDashboardData.pointsChartData.labels).map(l => `<th>${l}</th>`).join('')}</tr>
<tr><td>Points</td>${(lastDashboardData.pointsChartData.datasets?.[0]?.data ?? []).map(d => `<td>${d}</td>`).join('')}</tr>
</table>
` : ''}
</body>
</html>`;
            const blob = new Blob([html], { type: 'application/msword' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `TaskTrek-Dashboard-${new Date().toISOString().slice(0,10)}.doc`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        document.getElementById('export-excel-btn').addEventListener('click', exportAsExcel);
        document.getElementById('export-word-btn').addEventListener('click', exportAsWord);
    </script>
</body>
</html>
