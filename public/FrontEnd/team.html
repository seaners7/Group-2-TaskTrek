<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Team</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script>!function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);}catch(e){}}();</script>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Optional: Ensure icon colors adapt in light mode */
        [data-theme="light"] .nav__icon { stroke: var(--text-muted); }
        [data-theme="light"] .nav__item.active .nav__icon { stroke: var(--purple); }
        .theme-toggle-btn .theme-icon--sun { stroke: white; }
        [data-theme="light"] .theme-toggle-btn .theme-icon--sun { stroke: var(--text); }
        /* Style for invite code display */
        #invite-code-display { font-family: monospace; }
        .invite-code-section { display: none; /* Hidden by default */ }
    </style>
</head>
<body>
    <section class="app">
        <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle" aria-hidden="true" />
        <label for="sidebar-toggle" class="sidebar__hamburger" aria-label="Toggle navigation">
            <span></span><span></span><span></span>
        </label>

        <aside class="sidebar">
             <div class="sidebar__brand"><span class="logo-dot"></span><span class="brand-text">TaskTrek</span></div>
             <nav class="sidebar__nav">
                 <a href="dashboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg><span>Dashboard</span></a>
                 <a href="tasks.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Tasks</span></a>
                 <a href="shop.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12l2 6H4l2-6Z"/><path d="M4 8h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8Z"/><path d="M9 13h6"/></svg><span>Shop</span></a>
                 <a href="groups.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Groups</span></a>
                 <a href="leaderboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21V10"/><path d="M16 21V3"/><path d="M12 21v-6"/></svg><span>Leaderboard</span></a>
                 <a href="activity.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Activity</span></a>
                 <a href="team.html" class="nav__item active"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Team</span></a>
                 <a href="profile.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a>
             </nav>
             <div class="sidebar__footer">
                 <div class="theme-toggle"><button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme"><svg class="theme-icon theme-icon--sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><svg class="theme-icon theme-icon--moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button></div>
                 <a class="btn btn--ghost" id="logout-btn" href="#">Logout</a>
             </div>
        </aside>

        <div class="content">
            <section class="panel">
                <div class="panel__header">
                    <h2 id="team-name">Team Management</h2>
                    <div class="panel__actions invite-code-section" id="invite-section">
                        <input type="text" class="input" readonly id="invite-code-display" value="Invite Code: ..." style="width: auto; font-family: monospace;">
                        <button class="btn btn--primary" onclick="copyInviteCode()">Copy Code</button>
                    </div>
                    <button class="btn btn--primary" id="invite-member-button" onclick="openModal('addMemberModal')" style="display: none;">Invite Member</button>
                </div>

                <div class="team-stats">
                    <div class="stat-card">
                        <span class="stat-label">Total Members</span>
                        <span class="stat-value" id="stat-total-members">0</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">New This Week</span>
                        <span class="stat-value" id="stat-new-this-week">0</span>
                    </div>
                    </div>

                <div class="team-filters">
                    <select class="input" onchange="filterMembers(this.value)">
                        <option value="all">All Members</option>
                        <option value="admin">Admins Only</option>
                        <option value="member">Members Only</option>
                    </select>
                </div>

                <ul class="list list--team" id="team-list">
                    <li>Select an active group to see members.</li>
                </ul>
            </section>
        </div>

        <div id="addMemberModal" class="modal" style="display: none;">
             <div class="modal-content">
                <div class="modal-header"><h3>Invite New Member</h3><button class="btn btn--ghost" onclick="closeModal('addMemberModal')">&times;</button></div>
                <form id="inviteMemberForm" class="modal-form">
                    <div class="form-field"><label for="memberEmail">Email Address</label><input type="email" id="memberEmail" class="input" required placeholder="member@example.com"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn--ghost" onclick="closeModal('addMemberModal')">Cancel</button>
                        <button type="submit" class="btn btn--primary">Invite Member</button>
                    </div>
                </form>
             </div>
        </div>

        <div id="removeMemberModal" class="modal" style="display: none;">
             <div class="modal-content">
                <div class="modal-header"><h3>Remove Member</h3><button class="btn btn--ghost" onclick="closeModal('removeMemberModal')">&times;</button></div>
                <div class="modal-form">
                    <p>Are you sure you want to remove <strong id="memberToRemoveName"></strong> from the team?</p>
                    <p class="muted">This action cannot be undone.</p>
                    <input type="hidden" id="memberToRemoveId">
                    <div class="modal-actions">
                        <button type="button" class="btn btn--ghost" onclick="closeModal('removeMemberModal')">Cancel</button>
                        <button type="button" class="btn btn--danger" onclick="confirmRemoveMember()">Remove Member</button>
                    </div>
                </div>
             </div>
        </div>
    </section>

    <script src="theme.js"></script>
    <script type="module">
        import { db, auth, onAuthStateChanged, doc, updateDoc } from './firebase.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        // Ensure updateDoc is imported for direct Firestore updates
        import { collection, query, where, getDocs, onSnapshot, arrayRemove, arrayUnion, updateDoc as updateGroupDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";

        // UI Elements
        const teamListEl = document.getElementById('team-list');
        const teamNameEl = document.getElementById('team-name');
        const totalMembersEl = document.getElementById('stat-total-members');
        const newThisWeekEl = document.getElementById('stat-new-this-week');
        const inviteCodeDisplay = document.getElementById('invite-code-display');
        const inviteSection = document.getElementById('invite-section');
        const inviteMemberButton = document.getElementById('invite-member-button'); // Button to invite
        const logoutBtn = document.getElementById('logout-btn');
        const memberToRemoveNameEl = document.getElementById('memberToRemoveName');
        const memberToRemoveIdInput = document.getElementById('memberToRemoveId');
        const inviteMemberForm = document.getElementById('inviteMemberForm');

        // Global State
        let currentUser = null;
        let activeGroupId = null;
        let activeGroupData = null;
        let unsubscribeUserListener = null;
        let unsubscribeGroupListener = null;

        // Get Functions instance and references
        const functions = getFunctions();
        const inviteMemberToGroup = httpsCallable(functions, 'inviteMemberToGroup');
        const getGroupStats = httpsCallable(functions, 'getGroupStats');
        const toggleAdminStatus = httpsCallable(functions, 'toggleAdminStatus');

        // Global Modal Functions
        window.openModal = (modalId) => document.getElementById(modalId).style.display = 'flex';
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
            const form = modal.querySelector('form');
            if (form) form.reset();
        };
        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });

        // --- Core Logic: Listen for Active Group Change ---
        function listenForActiveGroup() {
            if (!currentUser) return;
            if (unsubscribeUserListener) unsubscribeUserListener();

            const userRef = doc(db, "users", currentUser.uid);
            unsubscribeUserListener = onSnapshot(userRef, (userDoc) => {
                 if (!userDoc.exists()) {
                     console.warn("User document not found.");
                     // Handle UI reset if needed
                     teamNameEl.textContent = "Error Loading Profile";
                     teamListEl.innerHTML = "<li>Cannot load group data.</li>";
                     totalMembersEl.textContent = '0'; newThisWeekEl.textContent = '0';
                     inviteSection.style.display = 'none'; inviteMemberButton.style.display = 'none';
                     return;
                 }
                const newActiveGroupId = userDoc.data()?.activeGroupId;
                if (!newActiveGroupId) {
                    teamNameEl.textContent = "No Active Group Selected";
                    teamListEl.innerHTML = "<li>Go to 'Groups' page to select or create a group.</li>";
                    totalMembersEl.textContent = '0'; newThisWeekEl.textContent = '0';
                    inviteSection.style.display = 'none'; inviteMemberButton.style.display = 'none';
                    activeGroupId = null; activeGroupData = null;
                    if (unsubscribeGroupListener) unsubscribeGroupListener();
                    return;
                }

                if (newActiveGroupId !== activeGroupId) {
                    activeGroupId = newActiveGroupId;
                    if (unsubscribeGroupListener) unsubscribeGroupListener();

                    const groupRef = doc(db, "groups", activeGroupId);
                    unsubscribeGroupListener = onSnapshot(groupRef, (groupDoc) => {
                        if (groupDoc.exists()) {
                            activeGroupData = groupDoc.data();
                            teamNameEl.textContent = activeGroupData.name || 'Unnamed Group';
                            inviteCodeDisplay.value = `Code: ${activeGroupData.inviteCode || 'N/A'}`;
                            const currentUserIsAdmin = activeGroupData.admins?.includes(currentUser.uid);

                            // Show invite section and button only if user is admin
                            inviteSection.style.display = currentUserIsAdmin ? 'flex' : 'none';
                            inviteMemberButton.style.display = currentUserIsAdmin ? 'inline-block' : 'none';

                            loadTeamMembers(activeGroupData.members || []); // Pass empty array if no members
                            fetchAndDisplayGroupStats(activeGroupId);
                        } else {
                            teamNameEl.textContent = "Group Not Found";
                            teamListEl.innerHTML = "<li>Error: Could not load the active group.</li>";
                            totalMembersEl.textContent = '0'; newThisWeekEl.textContent = '0';
                            inviteSection.style.display = 'none'; inviteMemberButton.style.display = 'none';
                            activeGroupId = null; activeGroupData = null;
                        }
                    }, (error) => {
                         console.error("Error listening to group doc:", error);
                         teamNameEl.textContent = "Error Loading Group";
                         teamListEl.innerHTML = "<li>Could not load group data.</li>";
                         inviteSection.style.display = 'none'; inviteMemberButton.style.display = 'none';
                     });
                } else if (activeGroupData) {
                    // If group ID hasn't changed, but maybe members/admins did - reload members
                     loadTeamMembers(activeGroupData.members || []);
                }
            }, (error) => {
                 console.error("Error listening to user doc:", error);
                 teamNameEl.textContent = "Error Loading User";
                 teamListEl.innerHTML = "<li>Cannot load group data.</li>";
                 inviteSection.style.display = 'none'; inviteMemberButton.style.display = 'none';
            });
        }

        // --- Fetch and Display Calculated Group Stats ---
        async function fetchAndDisplayGroupStats(groupId) {
            if (!groupId) return;
            newThisWeekEl.textContent = '...';
            try {
                const result = await getGroupStats({ groupId: groupId });
                const data = result.data;
                newThisWeekEl.textContent = data.newThisWeek ?? '0';
            } catch (error) {
                console.error("Error fetching group stats:", error);
                newThisWeekEl.textContent = 'Err';
            }
        }

        // --- Load and Render Team Members ---
        async function loadTeamMembers(memberIds) {
             if (!memberIds || memberIds.length === 0) {
                 teamListEl.innerHTML = "<li>This group has no members yet.</li>";
                 totalMembersEl.textContent = '0'; return;
             }
             // Firestore 'in' query limit is 30 as of v9/v10
             const idsToFetch = memberIds.slice(0, 30);
             if (memberIds.length > 30) {
                 console.warn(`Group has ${memberIds.length} members. Displaying first 30.`);
             }
             const membersQuery = query(collection(db, "users"), where("__name__", "in", idsToFetch));
             try {
                 const membersSnapshot = await getDocs(membersQuery);
                 teamListEl.innerHTML = ""; // Clear previous list
                 totalMembersEl.textContent = memberIds.length; // Show actual total count
                 const memberDataMap = new Map();
                 membersSnapshot.forEach(doc => memberDataMap.set(doc.id, doc.data()));

                 // Sort memberIds based on fetched points (descending)
                 const sortedMemberIds = [...memberIds].sort((a, b) => { // Use spread to avoid modifying original array if needed elsewhere
                     const pointsA = memberDataMap.get(a)?.points || 0;
                     const pointsB = memberDataMap.get(b)?.points || 0;
                     return pointsB - pointsA; // Higher points first
                 });

                 sortedMemberIds.forEach(memberId => {
                     const memberData = memberDataMap.get(memberId);
                     // Render even if data wasn't fetched (maybe show ID/email), or skip
                     if (memberData) {
                         renderMember(memberData, memberId);
                     } else if (idsToFetch.includes(memberId)) {
                        console.warn(`Data for member ${memberId} not found, skipping render.`);
                        // Optionally render a placeholder
                     }
                 });

                 // Apply current filter after rendering
                 const currentFilter = document.querySelector('.team-filters select').value;
                 filterMembers(currentFilter);

             } catch (error) {
                 console.error("Error loading team members:", error);
                 teamListEl.innerHTML = "<li>Error loading members. Check console (Index needed?).</li>";
             }
        }

        function renderMember(memberData, memberId) {
            const isCurrentUser = memberId === currentUser.uid;
            const isOwner = memberId === activeGroupData?.ownerId;
            const isAdmin = activeGroupData?.admins?.includes(memberId);
            const currentUserIsAdmin = activeGroupData?.admins?.includes(currentUser.uid);
            let roleLabel = 'Member';
            if (isOwner) roleLabel = 'Owner';
            else if (isAdmin) roleLabel = 'Admin';

            const li = document.createElement('li');
            li.className = `list-card team-member ${isCurrentUser ? 'current-user' : ''} ${isAdmin ? 'admin' : 'member'}`;
            li.dataset.role = isAdmin ? 'admin' : 'member'; // For filtering

            let actionButtonsHTML = '';
            if (isCurrentUser) {
                actionButtonsHTML = '<button class="btn btn--secondary" disabled>You</button>';
            } else if (currentUserIsAdmin) { // Only show admin actions if the current user is an admin
                if (!isOwner) { // Owner cannot be removed or demoted
                     actionButtonsHTML += `<button class="btn btn--danger btn--ghostlike" onclick="openRemoveMemberModal('${memberId}', '${memberData.name || memberId}')">Remove</button>`;

                     if (isAdmin) {
                         actionButtonsHTML += `<button class="btn btn--ghost" onclick="toggleAdmin('${memberId}', false)">Demote</button>`;
                     } else {
                         actionButtonsHTML += `<button class="btn btn--primary" onclick="toggleAdmin('${memberId}', true)">Make Admin</button>`;
                     }
                } else {
                    // Optionally show a disabled button or nothing for the owner
                    actionButtonsHTML = '<button class="btn btn--secondary" disabled>Owner</button>';
                }
            } else {
                // Non-admins see no action buttons for others
            }

            li.innerHTML = `
                <div class="avatar" style="background-image:url(${memberData.photoURL || ''})"></div>
                <div class="who">
                    <strong>${memberData.name || 'Unnamed User'} ${isCurrentUser ? '(You)' : ''}</strong>
                    <div class="muted">${roleLabel} • @${memberData.username || memberData.email}</div>
                    <div class="member-stats">${(memberData.points || 0).toLocaleString()} pts</div>
                </div>
                <div class="member-actions">${actionButtonsHTML}</div>`;
            teamListEl.appendChild(li);
        }

        // --- Actions (Exposed Globally) ---

        // Copy Invite Code
        window.copyInviteCode = () => {
             inviteCodeDisplay.select();
             try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    const codeOnly = activeGroupData?.inviteCode || '';
                    navigator.clipboard.writeText(codeOnly).then(() => {
                        alert('Invite code copied!');
                    });
                } else if (document.execCommand('copy')) {
                   alert('Invite code copied!');
                } else { throw new Error('Copy failed'); }
             } catch (err) {
                 console.error('Failed to copy code: ', err);
                 alert('Could not copy code.');
             }
             if (window.getSelection) window.getSelection().removeAllRanges();
             else if (document.selection) document.selection.empty();
        };

        // Open Remove Modal
        window.openRemoveMemberModal = (memberId, memberName) => {
            memberToRemoveNameEl.textContent = memberName;
            memberToRemoveIdInput.value = memberId;
            openModal('removeMemberModal');
        };

        // Confirm Remove Member - Uses direct Firestore update
        window.confirmRemoveMember = async () => {
            const memberIdToRemove = memberToRemoveIdInput.value;
            if (!memberIdToRemove || !activeGroupId || !currentUser) return;
            // Double check user is still admin (in case roles changed)
            if (!activeGroupData?.admins?.includes(currentUser.uid)) {
                 alert("You no longer have permission to remove members.");
                 closeModal('removeMemberModal');
                 return;
            }
             if (memberIdToRemove === activeGroupData?.ownerId) {
                alert("Cannot remove the group owner.");
                closeModal('removeMemberModal');
                return;
            }

            const groupRef = doc(db, "groups", activeGroupId);
            try {
                // Remove from both members and admins arrays
                await updateGroupDoc(groupRef, {
                    members: arrayRemove(memberIdToRemove),
                    admins: arrayRemove(memberIdToRemove) // Also remove admin status if they had it
                });
                console.log(`Member ${memberIdToRemove} removed from group ${activeGroupId}`);
                alert('Member removed successfully.');
                // The onSnapshot listener for the group should automatically refresh the list
            } catch (error) {
                console.error("Error removing member:", error);
                alert("Failed to remove member.");
            } finally {
                closeModal('removeMemberModal');
            }
        };

        // Toggle Admin Status - Uses Cloud Function
        window.toggleAdmin = async (targetUserId, makeAdmin) => {
             if (!activeGroupId || !currentUser) return;
             // Optimistic UI update (optional - remove if causing issues)
             const memberLi = teamListEl.querySelector(`.team-member [onclick*="'${targetUserId}'"]`)?.closest('.team-member');
             if (memberLi) {
                 memberLi.querySelector('.muted').textContent = `${makeAdmin ? 'Admin' : 'Member'} • ...`; // Update role temporarily
             }

            try {
                const result = await toggleAdminStatus({
                    groupId: activeGroupId,
                    targetUserId: targetUserId,
                    makeAdmin: makeAdmin
                });
                console.log(result.data.message);
                alert(result.data.message);
                 // Group listener will refresh the UI with correct state
            } catch (error) {
                console.error("Error toggling admin status:", error);
                alert(`Failed to update role: ${error.message || 'Check console'}`);
                // Revert optimistic UI update on error (if implemented)
                if (memberLi) {
                   // Force a reload to get correct state if optimistic update was done
                   loadTeamMembers(activeGroupData.members || []);
                }
            }
        };

        // Filter Members List (Client-side)
        window.filterMembers = (role) => {
            document.querySelectorAll('.team-member').forEach(li => {
                const memberRole = li.dataset.role; // 'admin' or 'member'
                let show = false;
                if (role === 'all') {
                    show = true;
                } else if (role === 'admin' && memberRole === 'admin') {
                    show = true;
                } else if (role === 'member' && memberRole === 'member') {
                    show = true;
                }
                li.style.display = show ? 'flex' : 'none'; // Use 'flex' since list items are flex containers
            });
        };

        // --- Invite Member Form Submission - Uses Cloud Function ---
        inviteMemberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!activeGroupId || !currentUser) return alert("No active group selected.");
             // Check admin status again before submitting
             if (!activeGroupData?.admins?.includes(currentUser.uid)) {
                 alert("You do not have permission to invite members.");
                 return;
             }

            const emailToInvite = inviteMemberForm.memberEmail.value.trim();
            if (!emailToInvite) return;

            const submitButton = inviteMemberForm.querySelector('button[type="submit"]');
            submitButton.disabled = true; submitButton.textContent = 'Inviting...';

            try {
                const result = await inviteMemberToGroup({
                    email: emailToInvite,
                    groupId: activeGroupId
                });
                alert(result.data.message); // Show success/already member message from function
                closeModal('addMemberModal');
                // The group listener will update the member list
            } catch (error) {
                console.error("Error inviting member:", error);
                alert(`Failed to invite member: ${error.message || 'Check console'}`);
            } finally {
                 submitButton.disabled = false; submitButton.textContent = 'Invite Member';
            }
        });

        // --- Logout & Initialize ---
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                listenForActiveGroup();
            } else {
                window.location.href = 'auth.html';
                if (unsubscribeUserListener) unsubscribeUserListener();
                if (unsubscribeGroupListener) unsubscribeGroupListener();
                 // Reset UI elements on logout
                 teamNameEl.textContent = "Team Management";
                 teamListEl.innerHTML = "<li>Loading...</li>";
                 totalMembersEl.textContent = '0'; newThisWeekEl.textContent = '0';
                 inviteSection.style.display = 'none'; inviteMemberButton.style.display = 'none';
            }
        });
    </script>
</body>
</html>