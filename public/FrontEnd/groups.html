<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Groups</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script>!function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);}catch(e){}}();</script>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Optional: Ensure icon colors adapt in light mode */
        [data-theme="light"] .nav__icon { stroke: var(--text-muted); }
        [data-theme="light"] .nav__item.active .nav__icon { stroke: var(--purple); }
        .theme-toggle-btn .theme-icon--sun { stroke: white; }
        [data-theme="light"] .theme-toggle-btn .theme-icon--sun { stroke: var(--text); }
        /* Optional Style Tweak for grid layout */
        .groups {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <section class="app">
        <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle" aria-hidden="true" />
        <label for="sidebar-toggle" class="sidebar__hamburger" aria-label="Toggle navigation">
            <span></span><span></span><span></span>
        </label>

        <aside class="sidebar">
            <div class="sidebar__brand"><span class="logo-dot"></span><span class="brand-text">TaskTrek</span></div>
            <nav class="sidebar__nav">
                <a href="dashboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg><span>Dashboard</span></a>
                <a href="tasks.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Tasks</span></a>
                <a href="shop.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12l2 6H4l2-6Z"/><path d="M4 8h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8Z"/><path d="M9 13h6"/></svg><span>Shop</span></a>
                <a href="groups.html" class="nav__item active"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Groups</span></a>
                <a href="leaderboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21V10"/><path d="M16 21V3"/><path d="M12 21v-6"/></svg><span>Leaderboard</span></a>
                <a href="activity.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Activity</span></a>
                <a href="team.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Team</span></a>
                <a href="profile.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a>
            </nav>
            <div class="sidebar__footer">
                <div class="theme-toggle">
                    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme">
                        <svg class="theme-icon theme-icon--sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                        <svg class="theme-icon theme-icon--moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    </button>
                </div>
                <a class="btn btn--ghost" id="logout-btn" href="#">Logout</a>
            </div>
        </aside>

        <div class="content">
            <section class="panel">
                <div class="panel__header">
                    <h2>Groups</h2>
                    <div class="panel__actions">
                        <button class="btn btn--primary" onclick="openModal('createGroupModal')">Create New Group</button>
                    </div>
                </div>

                <div class="groups">
                    <div class="groups__joined">
                        <h3>My Groups</h3>
                        <ul class="list list--groups" id="groups-list"><li>Loading...</li></ul>
                    </div>

                    <div class="groups__public">
                        <h3>Discover Public Groups</h3>
                        <ul class="list list--groups" id="public-groups-list"><li>Loading public groups...</li></ul>
                    </div>
                    <div class="groups__invite">
                        <h3>Join via Invite Code</h3>
                        <div class="invite-row">
                            <input class="input" type="text" placeholder="Enter 6-digit invite code" maxlength="6" id="inviteCodeInput" />
                            <button class="btn btn--primary" onclick="joinGroup()">Join</button>
                        </div>
                        <div class="group-actions">
                            </div>

                        <div class="group-info invite-code-section" id="active-group-invite-section" style="display: none; margin-top: 20px;">
                            <h4>Active Group Invite Code</h4>
                            <div class="invite-row">
                                <input class="input" type="text" readonly id="active-invite-code-display" value="..." style="font-family: monospace;"/>
                                <button class="btn btn--primary" onclick="copyActiveInviteCode()">Copy</button>
                            </div>
                            <p class="muted">Share this code with others to invite them to your active group.</p>
                        </div>
                        <div class="group-info"> <h4 id="current-group-info">Select an active group</h4>
                            <p>You're currently viewing data for your active group.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div id="joinGroupModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header"><h3>Join Group</h3><button class="btn btn--ghost" onclick="closeModal('joinGroupModal')">&times;</button></div>
                <form id="joinGroupForm" class="modal-form">
                    <div class="form-field"><label for="groupCodeInput">6-Digit Group Code</label><input type="text" id="groupCodeInput" class="input" required placeholder="Enter 6-digit code" maxlength="6" pattern="[A-Za-z0-9]{6}"><small class="muted">Ask your group admin for the invite code</small></div>
                    <div class="modal-actions"><button type="button" class="btn btn--ghost" onclick="closeModal('joinGroupModal')">Cancel</button><button type="submit" class="btn btn--primary">Join Group</button></div>
                </form>
            </div>
        </div>

        <div id="createGroupModal" class="modal" style="display: none;">
             <div class="modal-content">
                <div class="modal-header"><h3>Create New Group</h3><button class="btn btn--ghost" onclick="closeModal('createGroupModal')">&times;</button></div>
                <form id="createGroupForm" class="modal-form">
                    <div class="form-field"><label for="newGroupName">Group Name</label><input type="text" id="newGroupName" class="input" required placeholder="Enter group name"><div class="error-message" id="group-name-error"></div></div>
                    <div class="form-field"><label for="newGroupDescription">Description (Optional)</label><textarea id="newGroupDescription" class="input" rows="3" placeholder="Describe your group's purpose"></textarea></div>
                    <div class="form-field"><label for="newGroupType">Group Type</label><select id="newGroupType" class="input" required><option value="">Select group type</option><option value="academic">Academic</option><option value="study">Study Group</option><option value="project">Project Team</option><option value="club">Club/Organization</option><option value="other">Other</option></select></div>
                    <div class="form-field"><label for="maxMembers">Maximum Members (Optional)</label><input type="number" id="maxMembers" class="input" placeholder="Leave empty for unlimited" min="2" max="100"></div>
                    <div class="form-field"><label for="groupPrivacy">Privacy Settings</label><select id="groupPrivacy" class="input" required><option value="private">Private (Invite only)</option><option value="public">Public (Anyone can join)</option></select></div>
                    <div class="modal-actions"><button type="button" class="btn btn--ghost" onclick="closeModal('createGroupModal')">Cancel</button><button type="submit" class="btn btn--primary">Create Group</button></div>
                </form>
             </div>
        </div>
        
        <div id="deleteGroupModal" class="modal" style="display: none;">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Delete Group</h3>
              <button class="btn btn--ghost" onclick="closeModal('deleteGroupModal')">&times;</button>
            </div>
            <div class="modal-form">
                <p>Are you sure you want to permanently delete this group?</p>
                <p class="muted"><strong><span id="groupToDeleteName">Group Name Here</span></strong></p>
                <p class="muted" style="color: var(--danger);">This will also delete ALL tasks, shop items, and activities associated with this group. This action cannot be undone.</p>
                <input type="hidden" id="groupToDeleteId">
                <div class="modal-actions">
                    <button type="button" class="btn btn--ghost" onclick="closeModal('deleteGroupModal')">Cancel</button>
                    <button type="button" class="btn btn--danger" id="confirm-delete-button">
                        <span class="btn-text">Delete Group</span>
                        <span class="btn-spinner" style="display: none;">⏳</span>
                    </button>
                </div>
            </div>
          </div>
        </div>
        </section>

    <script src="theme.js"></script>

    <script type="module">
        import { db, auth, onAuthStateChanged, doc, updateDoc } from './firebase.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        // MODIFIED: Added getDoc, limit, deleteDoc
        import { collection, addDoc, query, where, getDocs, updateDoc as updateGroupDoc, arrayUnion, onSnapshot, serverTimestamp, limit, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        // ADDED: Imports for Cloud Functions
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-functions.js";

        // UI Elements
        const groupsListEl = document.getElementById('groups-list');
        const publicGroupsListEl = document.getElementById('public-groups-list');
        const currentGroupInfoEl = document.getElementById('current-group-info');
        const inviteCodeInput = document.getElementById('inviteCodeInput');
        const joinGroupForm = document.getElementById('joinGroupForm');
        const groupCodeInput = document.getElementById('groupCodeInput');
        const createGroupForm = document.getElementById('createGroupForm');
        const logoutBtn = document.getElementById('logout-btn');
        const groupNameErrorEl = document.getElementById('group-name-error');
        const activeGroupInviteSection = document.getElementById('active-group-invite-section');
        const activeInviteCodeDisplay = document.getElementById('active-invite-code-display');
        // ADDED: Delete Modal UI Elements
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const groupToDeleteName = document.getElementById('groupToDeleteName');
        const groupToDeleteId = document.getElementById('groupToDeleteId');


        let currentUser = null;
        let activeGroupId = null;
        let myGroupIds = new Set();
        
        // ADDED: Cloud Function reference
        const functions = getFunctions();
        const deleteGroup = httpsCallable(functions, 'deleteGroup'); // This function must be created

        // --- ADDED: setLoadingState Helper Function ---
        function setLoadingState(button, isLoading) {
            const text = button.querySelector('.btn-text');
            const spinner = button.querySelector('.btn-spinner');
            if (!button) return; // Guard clause
            // If button doesn't have spinner structure, just disable/enable
            if (!text || !spinner) {
                 button.disabled = isLoading;
                 return;
            }
            button.disabled = isLoading;
            text.style.display = isLoading ? 'none' : 'inline';
            spinner.style.display = isLoading ? 'inline' : 'none';
        }

        // --- Global Modal & Helper Functions ---
        window.openModal = (modalId) => document.getElementById(modalId).style.display = 'flex';
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
            const form = modal.querySelector('form');
            if (form) form.reset();
            groupNameErrorEl.textContent = '';
            // ADDED: Reset delete modal
            if (modalId === 'deleteGroupModal') {
                groupToDeleteName.textContent = '...';
                groupToDeleteId.value = '';
            }
        };
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });
        function generateInviteCode() { return Math.random().toString(36).substring(2, 8).toUpperCase(); }

        // --- Render Group List (My Groups) ---
        function renderGroups(snapshot) {
            groupsListEl.innerHTML = "";
            myGroupIds.clear();
            let activeGroupName = "Select an active group";
            let activeGroupInviteCode = null;
            let isCurrentUserAdminOfActive = false;

            if (snapshot.empty) groupsListEl.innerHTML = "<li>You're not in any groups yet.</li>";

            snapshot.forEach(doc => {
                myGroupIds.add(doc.id);
                const group = doc.data();
                const isActive = doc.id === activeGroupId;
                const isOwner = group.ownerId === currentUser.uid; // Check for ownership

                if (isActive) {
                    activeGroupName = `Active Group: ${group.name || 'Unnamed Group'}`;
                    activeGroupInviteCode = group.inviteCode;
                    isCurrentUserAdminOfActive = group.admins?.includes(currentUser.uid);
                }

                // ADDED: Delete button HTML (only if owner)
                const deleteButtonHtml = isOwner
                    ? `<button class="btn btn--danger btn--ghostlike" onclick="openDeleteGroupModal(event, '${doc.id}', '${group.name.replace(/'/g, "\\'")}')">Delete</button>`
                    : '';

                const li = document.createElement('li');
                li.className = `list-card group-card ${isActive ? 'active' : ''}`;
                li.innerHTML = `<div><strong>${group.name || 'Unnamed Group'}</strong><div class="muted">${group.members?.length || 0} members</div>${isActive ? '<div class="muted">Currently viewing</div>' : ''}</div>
                                <div style="display: flex; gap: 8px;"> <button class="btn ${isActive ? 'btn--primary' : 'btn--ghost'}" ${isActive ? 'disabled' : ''} onclick="switchGroup('${doc.id}')">${isActive ? 'Active' : 'Switch'}</button>
                                    ${deleteButtonHtml} </div>`;
                groupsListEl.appendChild(li);
            });

            currentGroupInfoEl.textContent = activeGroupName;

            if (activeGroupInviteCode && isCurrentUserAdminOfActive) {
                activeInviteCodeDisplay.value = activeGroupInviteCode;
                activeGroupInviteSection.style.display = 'block';
            } else {
                activeGroupInviteSection.style.display = 'none';
            }
            
            listenForPublicGroups();
        }

        // --- Render Public Group List ---
        function renderPublicGroups(snapshot) {
            publicGroupsListEl.innerHTML = "";
            let count = 0;
            snapshot.forEach(doc => {
                if (!myGroupIds.has(doc.id)) {
                    count++;
                    const group = doc.data();
                    const li = document.createElement('li');
                    li.className = 'list-card group-card';
                    li.innerHTML = `<div><strong>${group.name || 'Unnamed Group'}</strong><div class="muted">${group.members?.length || 0} members</div></div>
                                    <button class="btn btn--primary" onclick="joinPublicGroup('${doc.id}')">Join</button>`;
                    publicGroupsListEl.appendChild(li);
                }
            });
            if (count === 0 && myGroupIds.size > 0) {
                 publicGroupsListEl.innerHTML = "<li>No other public groups found or you're already in them.</li>";
            } else if (count === 0) {
                 publicGroupsListEl.innerHTML = "<li>No public groups found.</li>";
            }
        }

        // --- Listen for User and Group Changes ---
        function listenForUserAndGroups() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            onSnapshot(userRef, (userDoc) => {
                if (!userDoc.exists()) {
                    console.warn("User document not found, cannot load groups.");
                     groupsListEl.innerHTML = "<li>Error loading your profile.</li>";
                     publicGroupsListEl.innerHTML = "<li>Cannot load public groups.</li>";
                     activeGroupInviteSection.style.display = 'none';
                     return;
                }
                const newActiveGroupId = userDoc.data()?.activeGroupId;
                if (newActiveGroupId !== activeGroupId) {
                    activeGroupId = newActiveGroupId;
                }
                const groupsQuery = query(collection(db, "groups"), where("members", "array-contains", currentUser.uid));
                onSnapshot(groupsQuery, renderGroups, e => {
                    console.error("Error listening to user's groups:", e);
                    groupsListEl.innerHTML = "<li>Error loading your groups.</li>";
                    activeGroupInviteSection.style.display = 'none';
                });

            }, e => {
                console.error("Error listening to user doc:", e)
                groupsListEl.innerHTML = "<li>Error loading your profile.</li>";
                publicGroupsListEl.innerHTML = "<li>Cannot load public groups.</li>";
                activeGroupInviteSection.style.display = 'none';
            });
        }

        // --- Listen for Public Groups ---
        function listenForPublicGroups() {
            if (!currentUser) {
                publicGroupsListEl.innerHTML = "<li>Log in to see public groups.</li>";
                return;
            }
            const publicGroupsQuery = query(
                collection(db, "groups"),
                where("privacy", "==", "public"),
                limit(20)
            );
            onSnapshot(publicGroupsQuery, renderPublicGroups, e => {
                console.error("Error listening to public groups:", e);
                publicGroupsListEl.innerHTML = "<li>Error loading public groups. Check console (Index needed?).</li>";
            });
        }


        // --- Actions (Exposed Globally) ---
        window.switchGroup = async (groupId) => {
            if (!currentUser || !groupId) return;
            try {
                await updateDoc(doc(db, "users", currentUser.uid), { activeGroupId: groupId });
            } catch (err) { console.error("Error switching group:", err); }
        };

        async function handleJoinGroup(code) {
             if (!code || code.length !== 6 || !currentUser) return alert('Please enter a valid 6-digit invite code.');
             code = code.toUpperCase();
             const q = query(collection(db, "groups"), where("inviteCode", "==", code));
             const snapshot = await getDocs(q);
             if (snapshot.empty) return alert("Invalid invite code found.");
             
             const groupDoc = snapshot.docs[0];
             if (groupDoc.data().members?.includes(currentUser.uid)) {
                 return alert(`You are already a member of ${groupDoc.data().name}.`);
             }
             const groupRef = groupDoc.ref;
             await updateGroupDoc(groupRef, { members: arrayUnion(currentUser.uid) });
             alert(`Successfully joined ${groupDoc.data().name}!`);
        }

        window.joinGroup = () => {
            handleJoinGroup(inviteCodeInput.value.trim())
                .then(() => inviteCodeInput.value = '')
                .catch(err => console.error("Error joining group:", err));
        };

        joinGroupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleJoinGroup(groupCodeInput.value.trim())
                .then(() => closeModal('joinGroupModal'))
                .catch(err => console.error("Error joining group from modal:", err));
        });

        window.joinPublicGroup = async (groupId) => {
            if (!currentUser || !groupId) return alert('Cannot join group.');
            const groupRef = doc(db, "groups", groupId);
            try {
                 const groupDoc = await getDoc(groupRef);
                 if (groupDoc.exists() && groupDoc.data().members?.includes(currentUser.uid)) {
                     return alert(`You are already a member of ${groupDoc.data().name}.`);
                 }
                await updateGroupDoc(groupRef, {
                    members: arrayUnion(currentUser.uid)
                });
                alert(`Successfully joined ${groupDoc.data().name}!`);
            } catch (err) {
                console.error("Error joining public group:", err);
                alert("Failed to join group.");
            }
        };

        window.copyActiveInviteCode = () => {
            activeInviteCodeDisplay.select();
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(activeInviteCodeDisplay.value).then(() => {
                        alert('Invite code copied to clipboard!');
                    }, (err) => {
                         console.error('Async: Could not copy text: ', err);
                         alert('Could not copy code. Please copy it manually.');
                    });
                } else if (document.execCommand('copy')) {
                   alert('Invite code copied to clipboard!');
                } else { throw new Error('execCommand failed'); }
            } catch (err) {
                console.error('Failed to copy invite code: ', err);
                alert('Could not copy code. Please copy it manually.');
            }
             if (window.getSelection) window.getSelection().removeAllRanges();
             else if (document.selection) document.selection.empty();
        };

        // --- ADDED: Delete Group Functions ---
        window.openDeleteGroupModal = (event, groupId, groupName) => {
            event.stopPropagation(); // Stop click from propagating to the 'switch' button
            console.log(`Opening delete modal for: ${groupId} (${groupName})`);
            groupToDeleteName.textContent = groupName;
            groupToDeleteId.value = groupId;
            openModal('deleteGroupModal');
        };

        async function confirmDeleteGroup() {
            const groupId = groupToDeleteId.value;
            const groupName = groupToDeleteName.textContent;
            if (!groupId || !currentUser) return;

            setLoadingState(confirmDeleteButton, true);

            try {
                // Call the Cloud Function
                console.log(`Calling 'deleteGroup' Cloud Function for groupId: ${groupId}`);
                const result = await deleteGroup({ groupId: groupId });

                if (result.data.success) {
                    console.log(`Group ${groupId} deletion initiated.`);
                    alert(`Group "${groupName}" and all associated data have been deleted.`);
                    // The onSnapshot listener will automatically remove the group from the UI.
                } else {
                    // Handle errors returned from the function
                    throw new Error(result.data.error || 'Failed to delete group.');
                }

            } catch (error) {
                console.error("Error calling deleteGroup function:", error);
                alert(`Error: ${error.message}`);
            } finally {
                setLoadingState(confirmDeleteButton, false);
                closeModal('deleteGroupModal');
            }
        }
        // Attach listener to the confirmation button
        confirmDeleteButton.addEventListener('click', confirmDeleteGroup);


        // --- Create Group Form Submission ---
        createGroupForm.addEventListener('submit', async (e) => {
             e.preventDefault();
             if (!currentUser) return;
             const groupName = createGroupForm.newGroupName.value.trim();
             groupNameErrorEl.textContent = '';
             if (groupName.length < 3 || groupName.length > 50) {
                 groupNameErrorEl.textContent = 'Name must be 3-50 characters.'; return;
             }
             try {
                 const newGroupData = {
                     name: groupName, description: createGroupForm.newGroupDescription.value.trim(),
                     type: createGroupForm.newGroupType.value, maxMembers: parseInt(createGroupForm.maxMembers.value) || null,
                     privacy: createGroupForm.groupPrivacy.value, ownerId: currentUser.uid, members: [currentUser.uid],
                     admins: [currentUser.uid],
                     inviteCode: generateInviteCode(), createdAt: serverTimestamp()
                 };
                 const newGroupRef = await addDoc(collection(db, "groups"), newGroupData);
                 await window.switchGroup(newGroupRef.id);
                 alert(`Group "${groupName}" created! Invite code: ${newGroupData.inviteCode}`);
                 closeModal('createGroupModal');
             } catch (err) { console.error("Error creating group:", err); alert("Failed to create group."); }
        });

        // --- Logout & Initialize ---
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                listenForUserAndGroups();
                listenForPublicGroups();
            } else {
                window.location.href = 'auth.html';
                 groupsListEl.innerHTML = "<li>Loading...</li>";
                 publicGroupsListEl.innerHTML = "<li>Loading public groups...</li>";
                 myGroupIds.clear();
                 activeGroupInviteSection.style.display = 'none';
            }
        });
    </script>
</body>
</html>