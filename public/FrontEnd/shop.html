<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script>!function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);}catch(e){}}();</script>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Optional: Theme icon color adaptation */
        [data-theme="light"] .nav__icon { stroke: var(--text-muted); }
        [data-theme="light"] .nav__item.active .nav__icon { stroke: var(--purple); }
        .theme-toggle-btn .theme-icon--sun { stroke: white; }
        [data-theme="light"] .theme-toggle-btn .theme-icon--sun { stroke: var(--text); }

        /* Style for image preview in modal */
        #imagePreview {
             display: none; /* Hidden initially */
             max-width: 100px; max-height: 100px; margin-top: 5px; border-radius: 4px; border: 1px solid var(--outline);
        }
        /* Style for shop item image */
        .shop-thumb img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 12px;
        }
    </style>
</head>
<body>
    <section class="app">

        <input type="checkbox" id="sidebar-toggle" class="sidebar-toggle" aria-hidden="true" />
<label for="sidebar-toggle" class="sidebar__hamburger" aria-label="Toggle navigation">
    <span></span><span></span><span></span>
</label>
        <aside class="sidebar">
            <div class="sidebar__brand"><span class="logo-dot"></span><span class="brand-text">TaskTrek</span></div>
            <nav class="sidebar__nav">
                <a href="dashboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg><span>Dashboard</span></a>
                <a href="tasks.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Tasks</span></a>
                <a href="shop.html" class="nav__item active"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12l2 6H4l2-6Z"/><path d="M4 8h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8Z"/><path d="M9 13h6"/></svg><span>Shop</span></a>
                <a href="groups.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Groups</span></a>
                <a href="leaderboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21V10"/><path d="M16 21V3"/><path d="M12 21v-6"/></svg><span>Leaderboard</span></a>
                <a href="activity.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Activity</span></a>
                <a href="team.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Team</span></a>
                <a href="profile.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a>
            </nav>
            <div class="sidebar__footer">
                 <div class="theme-toggle"><button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme"><svg class="theme-icon theme-icon--sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><svg class="theme-icon theme-icon--moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button></div>
                 <a class="btn btn--ghost" id="logout-btn" href="#">Logout</a>
            </div>
        </aside>

        <div class="content">
            <section class="panel">
                <div class="panel__header">
                    <h2>Shop</h2>
                    <div class="panel__actions">
                        <input class="input" type="text" placeholder="Search rewards..." style="width: 200px;" oninput="searchRewards(this.value)">
                        <select class="input" style="width: auto;" onchange="filterRewards(this.value)">
                            <option value="all">All Items</option>
                            <option value="affordable">I Can Afford</option>
                            <option value="expensive">Too Expensive</option>
                            <option value="available">Available</option>
                        </select>
                        <button id="add-item-button" class="btn btn--primary" onclick="openModal('addItemModal')" style="display: none;">Add Item</button>
                    </div>
                </div>

                <div class="shop-summary">
                    <div class="stat-card"><span class="stat-label">Your Points</span><span class="stat-value" id="user-points">0</span></div>
                    <div class="stat-card"><span class="stat-label">Available Items</span><span class="stat-value" id="available-count">0</span></div>
                    <div class="stat-card"><span class="stat-label">You Can Afford</span><span class="stat-value" id="affordable-count">0</span></div>
                    <div class="stat-card"><span class="stat-label">Total Redeemed (You)</span><span class="stat-value" id="redeemed-count">0</span></div>
                </div>

                <div class="shop-grid" id="shop-grid">
                    <p>Loading shop items...</p>
                </div>
            </section>
        </div>

        <div id="addItemModal" class="modal" style="display: none;">
            <div class="modal-content">
              <div class="modal-header"><h3>Add Shop Item</h3><button class="btn btn--ghost" onclick="closeModal('addItemModal')">&times;</button></div>
              <form id="addItemForm" class="modal-form">
                <div class="form-field"><label for="itemName">Item Name</label><input type="text" id="itemName" class="input" required></div>
                <div class="form-field"><label for="itemPrice">Price (Points)</label><input type="number" id="itemPrice" class="input" required min="1"></div>
                <div class="form-field"><label for="itemQuantity">Quantity</label><input type="number" id="itemQuantity" class="input" required min="1"></div>
                <div class="form-field"><label for="itemDescription">Description (Optional)</label><textarea id="itemDescription" class="input" rows="3"></textarea></div>
                <div class="form-field">
                    <label for="itemImage">Image (Optional)</label>
                    <input type="file" id="itemImage" class="input" accept="image/*">
                    <img id="imagePreview" src="#" alt="Image Preview"/> </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn--ghost" onclick="closeModal('addItemModal')">Cancel</button>
                    <button type="submit" class="btn btn--primary" id="add-item-submit-button">
                        <span class="btn-text">Add Item</span>
                        <span class="btn-spinner" style="display: none;">⏳</span>
                    </button>
                </div>
              </form>
            </div>
        </div>


        <div id="redemptionModal" class="modal" style="display: none;">
             <div class="modal-content">
                <div class="modal-header"><h3>Confirm Redemption</h3><button class="btn btn--ghost" onclick="closeModal('redemptionModal')">&times;</button></div>
                <div class="modal-form">
                    <div class="redemption-details">
                        <div class="item-preview">
                             <div class="shop-thumb redemption-thumb" id="redemption-item-image"></div>
                            <div class="item-info">
                                <h4 id="confirm-item-name">Item Name</h4>
                                <p id="confirm-item-desc">Redeem for <strong id="confirm-item-cost">X points</strong></p>
                            </div>
                        </div>
                        <div class="balance-info">
                            <div class="current-balance"><span>Current Balance:</span><span id="current-balance">0 points</span></div>
                            <div class="after-redemption"><span>After Redemption:</span><span id="after-balance">0 points</span></div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn--ghost" onclick="closeModal('redemptionModal')">Cancel</button>
                        <button class="btn btn--primary" id="confirm-redeem-button">Confirm Redemption</button>
                    </div>
                </div>
             </div>
        </div>

        <div id="deleteItemModal" class="modal" style="display: none;">
            <div class="modal-content">
              <div class="modal-header">
                <h3>Delete Item</h3>
                <button class="btn btn--ghost" onclick="closeModal('deleteItemModal')">&times;</button>
              </div>
              <div class="modal-form">
                  <p>Are you sure you want to permanently delete this item?</p>
                  <p class="muted"><strong><span id="itemToDeleteName">Item Name Here</span></strong></p>
                  <p class="muted" style="color: var(--danger);">This action cannot be undone. Manually delete associated images from storage if needed.</p>
                  <input type="hidden" id="itemToDeleteId">
                  <div class="modal-actions">
                      <button type="button" class="btn btn--ghost" onclick="closeModal('deleteItemModal')">Cancel</button>
                      <button type="button" class="btn btn--danger" id="confirm-delete-button">
                          <span class="btn-text">Delete Item</span>
                          <span class="btn-spinner" style="display: none;">⏳</span>
                      </button>
                  </div>
              </div>
            </div>
          </div>
    </section>

    <script src="theme.js"></script>

    <script type="module">
        // --- Firebase Imports ---
        // Firestore
        import { db, auth, onAuthStateChanged, doc, increment, formatTimeAgo } from './firebase.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        // MODIFIED: Added deleteDoc
        import { collection, addDoc, query, onSnapshot, runTransaction, serverTimestamp, where, orderBy, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        // Storage
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

        // --- UI Elements ---
        const shopGridEl = document.getElementById('shop-grid');
        const userPointsEl = document.getElementById('user-points');
        const availableCountEl = document.getElementById('available-count');
        const affordableCountEl = document.getElementById('affordable-count');
        const redeemedCountEl = document.getElementById('redeemed-count');
        const addItemForm = document.getElementById('addItemForm');
        const addItemButton = document.getElementById('add-item-button');
        const addItemSubmitButton = document.getElementById('add-item-submit-button');
        const logoutBtn = document.getElementById('logout-btn');
        const confirmRedeemBtn = document.getElementById('confirm-redeem-button');
        const itemImageInput = document.getElementById('itemImage');
        const imagePreview = document.getElementById('imagePreview');

        // Redemption Modal Elements
        const confirmItemNameEl = document.getElementById('confirm-item-name');
        const confirmItemCostEl = document.getElementById('confirm-item-cost');
        const currentBalanceEl = document.getElementById('current-balance');
        const afterBalanceEl = document.getElementById('after-balance');
        const redemptionItemImageEl = document.getElementById('redemption-item-image');

        // ADDED: Delete Modal Elements
        const confirmDeleteButton = document.getElementById('confirm-delete-button');
        const itemToDeleteName = document.getElementById('itemToDeleteName');
        const itemToDeleteId = document.getElementById('itemToDeleteId');


        // --- Global State ---
        let currentUser = null;
        let userPoints = 0;
        let activeGroupId = null;
        let activeGroupData = null; // To store group data including admins
        let currentItemToRedeem = null;
        let unsubscribeUserListener = null;
        let unsubscribeShopListener = null;
        let unsubscribeRedeemedListener = null;
        let unsubscribeGroupListener = null;

        // --- Firebase Storage Instance ---
        const storage = getStorage();

        // --- Modal & Utility Functions ---
        window.openModal = (modalId) => document.getElementById(modalId).style.display = 'flex';
        // MODIFIED: closeModal to handle delete modal reset
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
            const form = modal.querySelector('form');
            if (form) form.reset();
            // Reset image preview specifically for addItemModal
            if (modalId === 'addItemModal') {
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
            }
             // Reset delete modal
            if (modalId === 'deleteItemModal') {
                itemToDeleteName.textContent = '...';
                itemToDeleteId.value = '';
            }
            currentItemToRedeem = null;
        };
        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });

         // Helper for loading state on buttons
        function setLoadingState(button, isLoading) {
            const text = button.querySelector('.btn-text');
            const spinner = button.querySelector('.btn-spinner');
            if (!button) return; // Guard clause
            
            // If button doesn't have spinner structure, just disable/enable
            if (!text || !spinner) {
                 button.disabled = isLoading;
                 return;
            }
            button.disabled = isLoading;
            text.style.display = isLoading ? 'none' : 'inline';
            spinner.style.display = isLoading ? 'inline' : 'none';
        }

        // --- Search and Filter ---
        window.searchRewards = (searchTerm) => {
            const term = searchTerm.toLowerCase().trim();
            window.filterRewards.lastSearch = term;
            const currentFilter = document.querySelector('.panel__actions select').value;
            filterRewards(currentFilter);
        };
        window.filterRewards = (filter) => {
            window.filterRewards.lastFilter = filter;
            const currentSearch = window.filterRewards.lastSearch || '';
            document.querySelectorAll('.shop-item').forEach(item => {
                const price = parseInt(item.dataset.price || '0');
                const stock = parseInt(item.dataset.stock || '0');
                const name = (item.dataset.name || '').toLowerCase();
                const isAffordable = price <= userPoints;
                let show = false;
                switch(filter) {
                    case 'all': show = true; break;
                    case 'affordable': show = isAffordable && stock > 0; break;
                    case 'expensive': show = !isAffordable && stock > 0; break;
                    case 'available': show = stock > 0; break;
                }
                if (show && currentSearch) {
                    show = name.includes(currentSearch);
                }
                item.style.display = show ? 'grid' : 'none';
            });
            updateShopSummary();
        };
        window.filterRewards.lastFilter = 'all';
        window.filterRewards.lastSearch = '';

        // --- Update Summary Cards ---
        function updateShopSummary() {
            const visibleItems = document.querySelectorAll('.shop-item[style*="display: grid"], .shop-item:not([style*="display: none"])');
            let affordable = 0, available = 0;
            visibleItems.forEach(item => {
                const price = parseInt(item.dataset.price || '0');
                const stock = parseInt(item.dataset.stock || '0');
                if (stock > 0) available++;
                if (price <= userPoints && stock > 0) affordable++;
            });
            availableCountEl.textContent = available;
            affordableCountEl.textContent = affordable;
        }

        // --- Render Functions ---
        function listenForShopItems() {
            if (unsubscribeShopListener) unsubscribeShopListener();
            if (!activeGroupId) {
                shopGridEl.innerHTML = '<p>Please select an active group on the "Groups" page to see the shop.</p>';
                updateShopSummary();
                return;
            }

            const q = query(collection(db, "shopItems"), where("groupId", "==", activeGroupId), orderBy("createdAt", "desc"));
            unsubscribeShopListener = onSnapshot(q, (snapshot) => {
                shopGridEl.innerHTML = '';
                if (snapshot.empty) shopGridEl.innerHTML = '<p>No items for this group yet.</p>';
                snapshot.forEach(doc => renderShopItem(doc.id, doc.data()));
                filterRewards(window.filterRewards.lastFilter);
                if (window.filterRewards.lastSearch) searchRewards(window.filterRewards.lastSearch);
            }, (error) => {
                console.error("Error listening for shop items (Index needed?):", error.message);
                shopGridEl.innerHTML = "<p>Error loading shop items. Check console.</p>";
            });
        }

        // --- MODIFIED: Render Shop Item ---
        function renderShopItem(id, data) {
            const itemEl = document.createElement('div');
            itemEl.className = 'shop-item';
            itemEl.dataset.id = id;
            itemEl.dataset.price = data.price || 0;
            itemEl.dataset.stock = data.stock || 0;
            itemEl.dataset.name = data.name || 'Unnamed Item';
            itemEl.dataset.description = data.description || '';
            itemEl.dataset.imageUrl = data.imageUrl || '';

            const itemPrice = parseInt(itemEl.dataset.price);
            const itemStock = parseInt(itemEl.dataset.stock);
            const canAfford = userPoints >= itemPrice;
            const inStock = itemStock > 0;

            let buttonHtml = `<button class="btn btn--secondary" disabled>Out of Stock</button>`;
            if (inStock) {
                if (canAfford) {
                    buttonHtml = `<button class="btn btn--primary" onclick="openRedeemModal('${id}', '${data.name || 'Item'}', ${itemPrice}, '${data.imageUrl || ''}')">Redeem</button>`;
                } else {
                    buttonHtml = `<button class="btn btn--secondary" disabled>Need ${itemPrice - userPoints} more pts</button>`;
                }
            }

            let imageHtml = '';
            if (data.imageUrl) {
                imageHtml = `<img src="${data.imageUrl}" alt="${itemEl.dataset.name}" loading="lazy">`;
            }

            // ADDED: Admin check and Delete Button
            const isAdmin = activeGroupData?.admins?.includes(currentUser.uid);
            const escapedName = (data.name || 'this item').replace(/'/g, "\\'"); // Escape quotes for onclick
            const deleteButtonHtml = isAdmin
                ? `<button class="btn btn--danger btn--ghostlike" style="grid-column: 1 / -1; margin-top: 5px;" onclick="openDeleteItemModal(event, '${id}', '${escapedName}')">Delete Item</button>`
                : '';

            itemEl.innerHTML = `
                <div class="shop-thumb">${imageHtml}</div>
                <h3>${itemEl.dataset.name}</h3>
                <div class="price">${itemPrice.toLocaleString()} pts</div>
                <div class="quantity">Stock: ${itemStock}</div>
                ${buttonHtml}
                ${deleteButtonHtml} `;
            shopGridEl.appendChild(itemEl);
        }

        // --- Actions ---
        window.openRedeemModal = (itemId, itemName, itemPrice, imageUrl) => {
            if (!currentUser) return alert('You must be logged in!');
            currentItemToRedeem = { id: itemId, name: itemName, price: itemPrice, imageUrl: imageUrl };
            confirmItemNameEl.textContent = itemName;
            confirmItemCostEl.textContent = `${itemPrice.toLocaleString()} points`;
            currentBalanceEl.textContent = `${userPoints.toLocaleString()} points`;
            afterBalanceEl.textContent = `${(userPoints - itemPrice).toLocaleString()} points`;

            if (imageUrl) {
                 redemptionItemImageEl.innerHTML = `<img src="${imageUrl}" alt="${itemName}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">`;
                 redemptionItemImageEl.style.background = 'none';
            } else {
                 redemptionItemImageEl.innerHTML = '';
                 redemptionItemImageEl.style.background = '';
            }

            openModal('redemptionModal');
        };

        // --- Confirm Redemption Function ---
        async function confirmRedemption() {
            console.log("confirmRedemption function started.");
            if (!currentItemToRedeem || !currentUser || !activeGroupId) {
                console.error("Cannot redeem: Missing item, user, or group ID.", { currentItemToRedeem, currentUser, activeGroupId });
                return alert("Cannot redeem item. User or group not identified.");
            }
            const { id: itemId, name: itemName, price: itemPrice } = currentItemToRedeem;
            const itemRef = doc(db, "shopItems", itemId);
            const userRef = doc(db, "users", currentUser.uid);

            confirmRedeemBtn.disabled = true;
            console.log("Attempting transaction for item:", itemId, "by user:", currentUser.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    console.log("Inside runTransaction callback.");
                    const itemDoc = await transaction.get(itemRef);
                    const userDoc = await transaction.get(userRef);
                    console.log("Docs fetched inside transaction:", { itemExists: itemDoc.exists(), userExists: userDoc.exists() });
                    if (!itemDoc.exists() || !userDoc.exists()) throw new Error("Data missing (item or user doc)");
                    const currentStock = itemDoc.data().stock || 0;
                    const currentPoints = userDoc.data().points || 0;
                    console.log("Checking conditions:", { currentStock, currentPoints, itemPrice });
                    if (currentStock <= 0) throw new Error("Item is out of stock!");
                    if (currentPoints < itemPrice) throw new Error("Not enough points!");
                    console.log("Conditions met, performing updates...");
                    transaction.update(itemRef, { stock: increment(-1) });
                    transaction.update(userRef, { points: increment(-itemPrice) });
                    transaction.set(doc(collection(db, "activities")), {
                        userId: currentUser.uid, userName: currentUser.displayName || 'User',
                        type: 'reward-redeemed', details: `redeemed ${itemName} for -${itemPrice} pts`,
                        createdAt: serverTimestamp(),
                        groupId: activeGroupId
                    });
                    console.log("Transaction updates queued.");
                });
                console.log("Transaction completed successfully.");
                alert(`Successfully redeemed ${itemName}!`);
            } catch (e) {
                console.error("Redemption transaction failed: ", e);
                alert("Redemption failed: " + (e.message || e));
            } finally {
                confirmRedeemBtn.disabled = false;
                closeModal('redemptionModal');
                console.log("confirmRedemption function finished.");
            }
        }
        confirmRedeemBtn.addEventListener('click', confirmRedemption);

        // --- ADDED: Delete Item Functions ---
        window.openDeleteItemModal = (event, itemId, itemName) => {
            event.stopPropagation(); // Stop click from propagating to card/redeem button
            if (!activeGroupData?.admins?.includes(currentUser.uid)) {
                return alert("You do not have permission to delete this item.");
            }
            console.log(`Opening delete modal for: ${itemId} (${itemName})`);
            itemToDeleteName.textContent = itemName;
            itemToDeleteId.value = itemId;
            openModal('deleteItemModal');
        };

        async function confirmDeleteItem() {
            const itemId = itemToDeleteId.value;
            if (!itemId || !currentUser) return;
            
            // Final check for permission
            if (!activeGroupData?.admins?.includes(currentUser.uid)) {
                alert("Permission error. Cannot delete item.");
                closeModal('deleteItemModal');
                return;
            }

            const itemRef = doc(db, "shopItems", itemId);
            setLoadingState(confirmDeleteButton, true);

            try {
                // Note: This does NOT delete the image from Firebase Storage.
                // That would require a Cloud Function for security.
                await deleteDoc(itemRef);
                console.log("Item deleted:", itemId);
                
                // onSnapshot will automatically re-render the list
                
            } catch (error) {
                console.error("Error deleting item:", error);
                alert("Failed to delete item.");
            } finally {
                setLoadingState(confirmDeleteButton, false);
                closeModal('deleteItemModal');
            }
        }
        confirmDeleteButton.addEventListener('click', confirmDeleteItem);
        // --- END ADDED ---

        // --- Add Item Form Submission with Image Upload ---
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !activeGroupId) return alert("User or group not identified.");
             if (!activeGroupData?.admins?.includes(currentUser.uid)) {
                 return alert("You do not have permission to add items.");
             }
            setLoadingState(addItemSubmitButton, true);
            const newItem = {
                name: addItemForm.itemName.value.trim(),
                price: parseInt(addItemForm.itemPrice.value),
                stock: parseInt(addItemForm.itemQuantity.value),
                description: addItemForm.itemDescription.value.trim(),
                createdAt: serverTimestamp(),
                groupId: activeGroupId,
                imageUrl: null
            };
             if (!newItem.name || isNaN(newItem.price) || isNaN(newItem.stock) || newItem.price <= 0 || newItem.stock < 0) {
                 setLoadingState(addItemSubmitButton, false);
                 return alert("Please enter valid item details.");
             }
            const imageFile = itemImageInput.files[0];
            let imageUrl = null;
            try {
                if (imageFile) {
                    console.log("Image file selected:", imageFile.name);
                    const imageFileName = `${Date.now()}-${imageFile.name}`;
                    const storageRef = ref(storage, `shopItemsImages/${activeGroupId}/${imageFileName}`);
                    console.log("Uploading to:", storageRef.fullPath);
                    const uploadResult = await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(uploadResult.ref);
                    console.log("Image uploaded, URL:", imageUrl);
                    newItem.imageUrl = imageUrl;
                } else {
                    console.log("No image file selected.");
                }
                await addDoc(collection(db, "shopItems"), newItem);
                console.log("Item added to Firestore:", newItem.name);
                closeModal('addItemModal');
            } catch (error) {
                console.error("Error adding item or uploading image: ", error);
                alert(`Failed to add item. ${error.message || ''}`);
            } finally {
                setLoadingState(addItemSubmitButton, false);
            }
        });

        // --- Image Preview Logic ---
        itemImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                 imagePreview.style.display = 'none';
                 imagePreview.src = '#';
            }
        });

        // --- Listen for User's Redeemed Count ---
        function listenForRedeemedCount(userId) {
             if (unsubscribeRedeemedListener) unsubscribeRedeemedListener();
             if (!activeGroupId) {
                 redeemedCountEl.textContent = '0';
                 return;
             }
             const rewardsQuery = query(
                 collection(db, "activities"), 
                 where("userId", "==", userId), 
                 where("type", "==", "reward-redeemed"), 
                 where("groupId", "==", activeGroupId)
             );
             unsubscribeRedeemedListener = onSnapshot(rewardsQuery, (snapshot) => {
                 redeemedCountEl.textContent = snapshot.size;
             }, (error) => {
                 console.error("Error fetching redeemed count (Index needed?):", error.message);
                 redeemedCountEl.textContent = '?';
             });
         }

        // --- Check Admin Status and Toggle Add Item Button ---
        function checkAdminStatusAndToggleButton() {
            if (currentUser && activeGroupData) {
                const isAdmin = activeGroupData.admins?.includes(currentUser.uid);
                addItemButton.style.display = isAdmin ? 'inline-block' : 'none';
            } else {
                addItemButton.style.display = 'none';
            }
        }

        // --- Logout & Initialize ---
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        onAuthStateChanged(auth, (user) => {
            // Clean up listeners
            if (unsubscribeUserListener) unsubscribeUserListener();
            if (unsubscribeGroupListener) unsubscribeGroupListener();
            if (unsubscribeShopListener) unsubscribeShopListener();
            if (unsubscribeRedeemedListener) unsubscribeRedeemedListener();
            // Reset state
            currentUser = null; activeGroupId = null; activeGroupData = null; userPoints = 0;
            shopGridEl.innerHTML = '<p>Loading...</p>';
            addItemButton.style.display = 'none';

            if (user) {
                currentUser = user;
                const userRef = doc(db, "users", user.uid);

                unsubscribeUserListener = onSnapshot(userRef, (userDocSnap) => {
                    if (!auth.currentUser) return; // Stale listener check

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        userPoints = userData.points || 0;
                        userPointsEl.textContent = userPoints.toLocaleString();
                        const newActiveGroupId = userData.activeGroupId;

                        if (newActiveGroupId !== activeGroupId) {
                            activeGroupId = newActiveGroupId;
                            activeGroupData = null;
                            checkAdminStatusAndToggleButton();

                            if (unsubscribeGroupListener) unsubscribeGroupListener();
                            if (unsubscribeShopListener) unsubscribeShopListener();
                            if (unsubscribeRedeemedListener) unsubscribeRedeemedListener();

                            if (activeGroupId) {
                                // Fetch Active Group Data
                                const groupRef = doc(db, "groups", activeGroupId);
                                unsubscribeGroupListener = onSnapshot(groupRef, (groupDocSnap) => {
                                    if (!auth.currentUser) return;
                                    if (groupDocSnap.exists()) {
                                        activeGroupData = groupDocSnap.data();
                                        checkAdminStatusAndToggleButton();
                                    } else {
                                        console.warn("Active group document not found:", activeGroupId);
                                        activeGroupData = null;
                                        checkAdminStatusAndToggleButton();
                                    }
                                    // (Re)start listeners dependent on group
                                    listenForShopItems();
                                    listenForRedeemedCount(user.uid);
                                }, (error) => {
                                     console.error("Error listening to group doc:", error);
                                     activeGroupData = null;
                                     checkAdminStatusAndToggleButton();
                                     listenForShopItems();
                                     listenForRedeemedCount(user.uid);
                                });
                            } else {
                                // No active group selected
                                activeGroupData = null;
                                checkAdminStatusAndToggleButton();
                                listenForShopItems();
                                listenForRedeemedCount(user.uid);
                            }
                        } else {
                            // Group ID same, but points might have changed
                            filterRewards(window.filterRewards.lastFilter);
                            if(window.filterRewards.lastSearch) searchRewards(window.filterRewards.lastSearch);
                            // Also re-check admin status in case group doc updated
                            checkAdminStatusAndToggleButton();
                        }
                    } else {
                        // User doc doesn't exist
                        userPoints = 0; userPointsEl.textContent = '0';
                        activeGroupId = null; activeGroupData = null;
                        checkAdminStatusAndToggleButton();
                        listenForShopItems();
                        listenForRedeemedCount(user.uid);
                    }
                }, (error) => { // Error listening to user doc
                    console.error("Error listening to user document:", error);
                    userPoints = 0; userPointsEl.textContent = '0';
                    activeGroupId = null; activeGroupData = null;
                    checkAdminStatusAndToggleButton();
                    listenForShopItems();
                    listenForRedeemedCount(user.uid);
                });
            } else { // User logged out
                window.location.href = 'auth.html';
            }
        });
    </script>
</body>
</html>