<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <script>!function(){try{var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);}catch(e){}}();</script>
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Optional: Theme icon color adaptation */
        [data-theme="light"] .nav__icon { stroke: var(--text-muted); }
        [data-theme="light"] .nav__item.active .nav__icon { stroke: var(--purple); }
        .theme-toggle-btn .theme-icon--sun { stroke: white; }
        [data-theme="light"] .theme-toggle-btn .theme-icon--sun { stroke: var(--text); }

        /* Style for image preview in modal */
        #imagePreview {
             display: none; /* Hidden initially */
             max-width: 100px; max-height: 100px; margin-top: 5px; border-radius: 4px; border: 1px solid var(--outline);
        }
        /* Style for shop item image */
        .shop-thumb img {
            width: 100%; height: 100%; object-fit: cover; border-radius: 12px;
        }
    </style>
</head>
<body>
    <section class="app">
        <aside class="sidebar">
            <div class="sidebar__brand"><span class="logo-dot"></span><span class="brand-text">TaskTrek</span></div>
            <nav class="sidebar__nav">
                <a href="dashboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7" rx="2"/><rect x="14" y="3" width="7" height="7" rx="2"/><rect x="14" y="14" width="7" height="7" rx="2"/><rect x="3" y="14" width="7" height="7" rx="2"/></svg><span>Dashboard</span></a>
                <a href="tasks.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/><rect x="3" y="3" width="18" height="18" rx="3"/></svg><span>Tasks</span></a>
                <a href="shop.html" class="nav__item active"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2h12l2 6H4l2-6Z"/><path d="M4 8h16v9a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3V8Z"/><path d="M9 13h6"/></svg><span>Shop</span></a>
                <a href="groups.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Groups</span></a>
                <a href="leaderboard.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21V10"/><path d="M16 21V3"/><path d="M12 21v-6"/></svg><span>Leaderboard</span></a>
                <a href="activity.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg><span>Activity</span></a>
                <a href="team.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Team</span></a>
                <a href="profile.html" class="nav__item"><svg xmlns="http://www.w3.org/2000/svg" class="nav__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21a8 8 0 1 0-16 0"/><circle cx="12" cy="7" r="4"/></svg><span>Profile</span></a>
            </nav>
            <div class="sidebar__footer">
                 <div class="theme-toggle"><button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle theme"><svg class="theme-icon theme-icon--sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg><svg class="theme-icon theme-icon--moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button></div>
                 <a class="btn btn--ghost" id="logout-btn" href="#">Logout</a>
            </div>
        </aside>

        <div class="content">
            <section class="panel">
                <div class="panel__header">
                    <h2>Shop</h2>
                    <div class="panel__actions">
                        <input class="input" type="text" placeholder="Search rewards..." style="width: 200px;" oninput="searchRewards(this.value)">
                        <select class="input" style="width: auto;" onchange="filterRewards(this.value)">
                            <option value="all">All Items</option>
                            <option value="affordable">I Can Afford</option>
                            <option value="expensive">Too Expensive</option>
                            <option value="available">Available</option>
                        </select>
                        <button id="add-item-button" class="btn btn--primary" onclick="openModal('addItemModal')" style="display: none;">Add Item</button>
                    </div>
                </div>

                <div class="shop-summary">
                    <div class="stat-card"><span class="stat-label">Your Points</span><span class="stat-value" id="user-points">0</span></div>
                    <div class="stat-card"><span class="stat-label">Available Items</span><span class="stat-value" id="available-count">0</span></div>
                    <div class="stat-card"><span class="stat-label">You Can Afford</span><span class="stat-value" id="affordable-count">0</span></div>
                    <div class="stat-card"><span class="stat-label">Total Redeemed (You)</span><span class="stat-value" id="redeemed-count">0</span></div>
                </div>

                <div class="shop-grid" id="shop-grid">
                    <p>Loading shop items...</p>
                </div>
            </section>
        </div>

        <div id="addItemModal" class="modal" style="display: none;">
            <div class="modal-content">
              <div class="modal-header"><h3>Add Shop Item</h3><button class="btn btn--ghost" onclick="closeModal('addItemModal')">&times;</button></div>
              <form id="addItemForm" class="modal-form">
                <div class="form-field"><label for="itemName">Item Name</label><input type="text" id="itemName" class="input" required></div>
                <div class="form-field"><label for="itemPrice">Price (Points)</label><input type="number" id="itemPrice" class="input" required min="1"></div>
                <div class="form-field"><label for="itemQuantity">Quantity</label><input type="number" id="itemQuantity" class="input" required min="1"></div>
                <div class="form-field"><label for="itemDescription">Description (Optional)</label><textarea id="itemDescription" class="input" rows="3"></textarea></div>
                <div class="form-field">
                    <label for="itemImage">Image (Optional)</label>
                    <input type="file" id="itemImage" class="input" accept="image/*">
                    <img id="imagePreview" src="#" alt="Image Preview"/> </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn--ghost" onclick="closeModal('addItemModal')">Cancel</button>
                    <button type="submit" class="btn btn--primary" id="add-item-submit-button">
                        <span class="btn-text">Add Item</span>
                        <span class="btn-spinner" style="display: none;">⏳</span>
                    </button>
                </div>
              </form>
            </div>
        </div>


        <div id="redemptionModal" class="modal" style="display: none;">
             <div class="modal-content">
                <div class="modal-header"><h3>Confirm Redemption</h3><button class="btn btn--ghost" onclick="closeModal('redemptionModal')">&times;</button></div>
                <div class="modal-form">
                    <div class="redemption-details">
                        <div class="item-preview">
                             <div class="shop-thumb redemption-thumb" id="redemption-item-image"></div>
                            <div class="item-info">
                                <h4 id="confirm-item-name">Item Name</h4>
                                <p id="confirm-item-desc">Redeem for <strong id="confirm-item-cost">X points</strong></p>
                            </div>
                        </div>
                        <div class="balance-info">
                            <div class="current-balance"><span>Current Balance:</span><span id="current-balance">0 points</span></div>
                            <div class="after-redemption"><span>After Redemption:</span><span id="after-balance">0 points</span></div>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn--ghost" onclick="closeModal('redemptionModal')">Cancel</button>
                        <button class="btn btn--primary" id="confirm-redeem-button">Confirm Redemption</button>
                    </div>
                </div>
             </div>
        </div>
    </section>

    <script src="theme.js"></script>

    <script type="module">
        // --- Firebase Imports ---
        // Firestore
        import { db, auth, onAuthStateChanged, doc, increment, formatTimeAgo } from './firebase.js'; // Assuming firebase.js exports necessary Firestore functions
        import { signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { collection, addDoc, query, onSnapshot, runTransaction, serverTimestamp, where, orderBy, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
        // Storage
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

        // --- UI Elements ---
        const shopGridEl = document.getElementById('shop-grid');
        const userPointsEl = document.getElementById('user-points');
        const availableCountEl = document.getElementById('available-count');
        const affordableCountEl = document.getElementById('affordable-count');
        const redeemedCountEl = document.getElementById('redeemed-count');
        const addItemForm = document.getElementById('addItemForm');
        const addItemButton = document.getElementById('add-item-button'); // Button in header
        const addItemSubmitButton = document.getElementById('add-item-submit-button'); // Button in modal
        const logoutBtn = document.getElementById('logout-btn');
        const confirmRedeemBtn = document.getElementById('confirm-redeem-button');
        const itemImageInput = document.getElementById('itemImage'); // File input
        const imagePreview = document.getElementById('imagePreview'); // Image preview in modal

        // Redemption Modal Elements
        const confirmItemNameEl = document.getElementById('confirm-item-name');
        const confirmItemCostEl = document.getElementById('confirm-item-cost');
        const currentBalanceEl = document.getElementById('current-balance');
        const afterBalanceEl = document.getElementById('after-balance');
        const redemptionItemImageEl = document.getElementById('redemption-item-image'); // Image in redemption modal


        // --- Global State ---
        let currentUser = null;
        let userPoints = 0;
        let activeGroupId = null;
        let activeGroupData = null; // To store group data including admins
        let currentItemToRedeem = null;
        let unsubscribeUserListener = null;
        let unsubscribeShopListener = null;
        let unsubscribeRedeemedListener = null;
        let unsubscribeGroupListener = null; // Listener for group data

        // --- Firebase Storage Instance ---
        const storage = getStorage(); // Initialize storage

        // --- Modal & Utility Functions ---
        window.openModal = (modalId) => document.getElementById(modalId).style.display = 'flex';
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.style.display = 'none';
            const form = modal.querySelector('form');
            if (form) form.reset();
             // Reset image preview specifically for addItemModal
            if (modalId === 'addItemModal') {
                imagePreview.style.display = 'none';
                imagePreview.src = '#';
            }
            currentItemToRedeem = null;
        };
        document.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) closeModal(e.target.id); });

         // Helper for loading state on buttons
        function setLoadingState(button, isLoading) {
            const text = button.querySelector('.btn-text');
            const spinner = button.querySelector('.btn-spinner');
            if (!text || !spinner) return; // Ignore if elements not found
            if (isLoading) {
                button.disabled = true;
                text.style.display = 'none';
                spinner.style.display = 'inline';
            } else {
                button.disabled = false;
                text.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        // --- Search and Filter (Keep existing) ---
        window.searchRewards = (searchTerm) => { /* ... keep existing ... */ };
        window.filterRewards = (filter) => { /* ... keep existing ... */ };
        window.filterRewards.lastFilter = 'all';
        window.filterRewards.lastSearch = '';

        // --- Update Summary Cards (Keep existing) ---
        function updateShopSummary() { /* ... keep existing ... */ }

        // --- Render Functions ---
        function listenForShopItems() {
            if (unsubscribeShopListener) unsubscribeShopListener();
            if (!activeGroupId) {
                shopGridEl.innerHTML = '<p>Please select an active group on the "Groups" page to see the shop.</p>';
                updateShopSummary();
                return;
            }

            const q = query(collection(db, "shopItems"), where("groupId", "==", activeGroupId), orderBy("createdAt", "desc"));
            unsubscribeShopListener = onSnapshot(q, (snapshot) => {
                shopGridEl.innerHTML = '';
                if (snapshot.empty) shopGridEl.innerHTML = '<p>No items for this group yet.</p>';
                snapshot.forEach(doc => renderShopItem(doc.id, doc.data()));
                filterRewards(window.filterRewards.lastFilter); // Apply filters after rendering
                if (window.filterRewards.lastSearch) searchRewards(window.filterRewards.lastSearch);
            }, (error) => {
                console.error("Error listening for shop items (Index needed?):", error.message);
                shopGridEl.innerHTML = "<p>Error loading shop items. Check console.</p>";
            });
        }

        // --- MODIFIED: Render Shop Item to include image ---
        function renderShopItem(id, data) {
            const itemEl = document.createElement('div');
            itemEl.className = 'shop-item';
            itemEl.dataset.id = id;
            itemEl.dataset.price = data.price || 0;
            itemEl.dataset.stock = data.stock || 0;
            itemEl.dataset.name = data.name || 'Unnamed Item';
            itemEl.dataset.description = data.description || '';
            itemEl.dataset.imageUrl = data.imageUrl || ''; // Store image URL

            const itemPrice = parseInt(itemEl.dataset.price);
            const itemStock = parseInt(itemEl.dataset.stock);
            const canAfford = userPoints >= itemPrice;
            const inStock = itemStock > 0;

            let buttonHtml = `<button class="btn btn--secondary" disabled>Out of Stock</button>`;
            if (inStock) {
                if (canAfford) {
                    // Pass imageUrl to openRedeemModal
                    buttonHtml = `<button class="btn btn--primary" onclick="openRedeemModal('${id}', '${data.name || 'Item'}', ${itemPrice}, '${data.imageUrl || ''}')">Redeem</button>`;
                } else {
                    buttonHtml = `<button class="btn btn--secondary" disabled>Need ${itemPrice - userPoints} more pts</button>`;
                }
            }

            // Image display logic
            let imageHtml = '';
            if (data.imageUrl) {
                imageHtml = `<img src="${data.imageUrl}" alt="${itemEl.dataset.name}" loading="lazy">`;
            } else {
                 // Keep default gradient background if no image
                imageHtml = ''; // Or could add a placeholder SVG/icon here
            }


            itemEl.innerHTML = `
                <div class="shop-thumb">${imageHtml}</div>
                <h3>${itemEl.dataset.name}</h3>
                <div class="price">${itemPrice.toLocaleString()} pts</div>
                <div class="quantity">Stock: ${itemStock}</div>
                ${buttonHtml}
            `;
            shopGridEl.appendChild(itemEl);
        }

        // --- MODIFIED: Actions ---
        // Include imageUrl parameter
        window.openRedeemModal = (itemId, itemName, itemPrice, imageUrl) => {
            if (!currentUser) return alert('You must be logged in!');
            currentItemToRedeem = { id: itemId, name: itemName, price: itemPrice, imageUrl: imageUrl };
            confirmItemNameEl.textContent = itemName;
            confirmItemCostEl.textContent = `${itemPrice.toLocaleString()} points`;
            currentBalanceEl.textContent = `${userPoints.toLocaleString()} points`;
            afterBalanceEl.textContent = `${(userPoints - itemPrice).toLocaleString()} points`;

             // Display image in redemption modal
            if (imageUrl) {
                 redemptionItemImageEl.innerHTML = `<img src="${imageUrl}" alt="${itemName}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">`;
                 redemptionItemImageEl.style.background = 'none'; // Remove default background
            } else {
                 redemptionItemImageEl.innerHTML = ''; // Clear image
                 redemptionItemImageEl.style.background = ''; // Restore default background if needed
            }


            openModal('redemptionModal');
        };

        async function confirmRedemption() { /* ... keep existing transaction logic ... */ }
        confirmRedeemBtn.addEventListener('click', confirmRedemption);

        // --- MODIFIED: Add Item Form Submission with Image Upload ---
        addItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !activeGroupId) return alert("User or group not identified.");
            // Check if user is admin before proceeding
             if (!activeGroupData?.admins?.includes(currentUser.uid)) {
                 return alert("You do not have permission to add items.");
             }

            setLoadingState(addItemSubmitButton, true); // Start loading

            const newItem = {
                name: addItemForm.itemName.value.trim(),
                price: parseInt(addItemForm.itemPrice.value),
                stock: parseInt(addItemForm.itemQuantity.value),
                description: addItemForm.itemDescription.value.trim(),
                createdAt: serverTimestamp(),
                groupId: activeGroupId,
                imageUrl: null // Initialize imageUrl as null
            };

             if (!newItem.name || isNaN(newItem.price) || isNaN(newItem.stock) || newItem.price <= 0 || newItem.stock < 0) {
                 setLoadingState(addItemSubmitButton, false);
                 return alert("Please enter valid item details.");
             }

            const imageFile = itemImageInput.files[0];
            let imageUrl = null;

            try {
                // --- Upload Image if selected ---
                if (imageFile) {
                    console.log("Image file selected:", imageFile.name);
                    // Create a unique path e.g., shopItemsImages/groupId/timestamp-filename
                    const imageFileName = `${Date.now()}-${imageFile.name}`;
                    const storageRef = ref(storage, `shopItemsImages/${activeGroupId}/${imageFileName}`);

                    console.log("Uploading to:", storageRef.fullPath);
                    const uploadResult = await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(uploadResult.ref);
                    console.log("Image uploaded, URL:", imageUrl);
                    newItem.imageUrl = imageUrl; // Add URL to the item data
                } else {
                    console.log("No image file selected.");
                }

                // --- Add item data to Firestore ---
                await addDoc(collection(db, "shopItems"), newItem);
                console.log("Item added to Firestore:", newItem.name);
                closeModal('addItemModal');

            } catch (error) {
                console.error("Error adding item or uploading image: ", error);
                alert(`Failed to add item. ${error.message || ''}`);
            } finally {
                setLoadingState(addItemSubmitButton, false); // Stop loading
            }
        });

        // --- Image Preview Logic ---
        itemImageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                 imagePreview.style.display = 'none';
                 imagePreview.src = '#';
            }
        });


        // --- Listen for User's Redeemed Count (Keep existing) ---
        function listenForRedeemedCount(userId) { /* ... keep existing ... */ }

        // --- Check Admin Status and Toggle Add Item Button ---
        function checkAdminStatusAndToggleButton() {
            if (currentUser && activeGroupData) {
                const isAdmin = activeGroupData.admins?.includes(currentUser.uid);
                addItemButton.style.display = isAdmin ? 'inline-block' : 'none';
            } else {
                addItemButton.style.display = 'none'; // Hide if no user or group data
            }
        }

        // --- Logout & Initialize ---
        logoutBtn.addEventListener('click', (e) => { e.preventDefault(); signOut(auth); });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                if (unsubscribeUserListener) unsubscribeUserListener();
                if (unsubscribeGroupListener) unsubscribeGroupListener(); // Clean up group listener too

                const userRef = doc(db, "users", user.uid);

                unsubscribeUserListener = onSnapshot(userRef, (userDocSnap) => {
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        userPoints = userData.points || 0;
                        userPointsEl.textContent = userPoints.toLocaleString();
                        const newActiveGroupId = userData.activeGroupId;

                        if (newActiveGroupId !== activeGroupId) { // Group changed or loaded first time
                            activeGroupId = newActiveGroupId;
                            activeGroupData = null; // Reset group data
                            checkAdminStatusAndToggleButton(); // Hide button until group data loaded

                            if (unsubscribeGroupListener) unsubscribeGroupListener(); // Clean up previous group listener

                            if (activeGroupId) {
                                // --- Fetch Active Group Data ---
                                const groupRef = doc(db, "groups", activeGroupId);
                                unsubscribeGroupListener = onSnapshot(groupRef, (groupDocSnap) => {
                                    if (groupDocSnap.exists()) {
                                        activeGroupData = groupDocSnap.data(); // Store group data
                                        checkAdminStatusAndToggleButton(); // Show/hide button based on admin status
                                    } else {
                                        console.warn("Active group document not found:", activeGroupId);
                                        activeGroupData = null;
                                        checkAdminStatusAndToggleButton(); // Hide button
                                    }
                                    listenForShopItems(); // Load/reload items for the (new) active group
                                    listenForRedeemedCount(user.uid); // Load/reload redeemed count for the group
                                }, (error) => {
                                     console.error("Error listening to group doc:", error);
                                     activeGroupData = null;
                                     checkAdminStatusAndToggleButton(); // Hide button on error
                                     listenForShopItems(); // Show error message in shop grid
                                     listenForRedeemedCount(user.uid); // Reset count maybe?
                                });
                            } else {
                                // No active group selected
                                activeGroupData = null;
                                checkAdminStatusAndToggleButton();
                                listenForShopItems(); // Will show "select group" message
                                listenForRedeemedCount(user.uid); // Will reset count
                            }

                        } else {
                            // Group ID hasn't changed, but user points might have. Re-filter.
                            filterRewards(window.filterRewards.lastFilter);
                            if(window.filterRewards.lastSearch) searchRewards(window.filterRewards.lastSearch);
                        }
                    } else {
                        // User doc doesn't exist
                        userPoints = 0; userPointsEl.textContent = '0';
                        activeGroupId = null; activeGroupData = null;
                        checkAdminStatusAndToggleButton();
                        listenForShopItems();
                        listenForRedeemedCount(user.uid);
                    }
                }, (error) => { // Error listening to user doc
                    console.error("Error listening to user document:", error);
                    // Reset UI
                    userPoints = 0; userPointsEl.textContent = '0';
                    activeGroupId = null; activeGroupData = null;
                    checkAdminStatusAndToggleButton();
                    listenForShopItems();
                    listenForRedeemedCount(user.uid);
                });
            } else { // User logged out
                currentUser = null; activeGroupId = null; activeGroupData = null; userPoints = 0;
                window.location.href = 'auth.html';
                if (unsubscribeUserListener) unsubscribeUserListener();
                if (unsubscribeShopListener) unsubscribeShopListener();
                if (unsubscribeRedeemedListener) unsubscribeRedeemedListener();
                if (unsubscribeGroupListener) unsubscribeGroupListener();
                 addItemButton.style.display = 'none'; // Ensure button is hidden on logout
            }
        });
    </script>
</body>
</html>