<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Reset Password</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <style>
        /* Add specific styles if needed */
        .status-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .status-message.success { background-color: rgba(34, 197, 94, 0.2); border: 1px solid var(--success); color: var(--success);}
        .status-message.error { background-color: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger); color: var(--danger);}
    </style>
</head>
<body>
    <main class="auth"> <a class="auth__back" href="auth.html">← Back to Login</a>

        <div class="auth__card"> <div class="auth__brand">
                <span class="logo-dot"></span>
                <span class="brand-text">TaskTrek</span>
            </div>
            <h3>Set New Password</h3>

            <div id="statusMessage" class="status-message" style="display: none;"></div>

            <form id="resetPasswordForm" style="display: none;">
                <p>Please enter your new password for <strong id="resetEmail">your email</strong>.</p>

                <div class="form-field">
                    <label for="newPassword">New Password</label>
                    <input class="input" type="password" id="newPassword" placeholder="Create a new password" required oninput="validatePassword()" />
                    <div class="password-requirements" id="password-requirements">
                        <div class="requirement invalid" id="req-length">✗ At least 8 characters</div>
                        <div class="requirement invalid" id="req-uppercase">✗ One uppercase letter</div>
                        <div class="requirement invalid" id="req-lowercase">✗ One lowercase letter</div>
                        <div class="requirement invalid" id="req-number">✗ One number</div>
                        <div class="requirement invalid" id="req-special">✗ One special character</div>
                        <div class="requirement invalid" id="req-nospace">✗ No spaces allowed</div>
                    </div>
                    <div class="error-message" id="newPassword-error"></div>
                </div>

                <div class="form-field">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input class="input" type="password" id="confirmPassword" placeholder="Confirm your new password" required />
                    <div class="error-message" id="confirmPassword-error"></div>
                </div>

                <div class="form-row" style="margin-top: 15px;">
                    <button class="btn btn--primary" type="submit" id="resetSubmitButton">
                        <span class="btn-text">Save New Password</span>
                        <span class="btn-spinner" style="display: none;">⏳</span>
                    </button>
                </div>
            </form>

            <p id="loadingMessage">Verifying your request...</p>

        </div>
    </main>

    <script type="module">
        // Use latest v9+ modular imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import {
            getAuth,
            verifyPasswordResetCode,
            confirmPasswordReset
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        // --- Your Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVZmortwiPrLezWCxQo53u60b4-IGgeWw",
            authDomain: "tasktrek-e7a04.firebaseapp.com",
            projectId: "tasktrek-e7a04",
            storageBucket: "tasktrek-e7a04.firebasestorage.app",
            messagingSenderId: "900463967783",
            appId: "1:900463967783:web:9dc9485517aa908fbdd802",
            measurementId: "G-6BCT9FME3V"
        };

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- UI Elements ---
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const loadingMessage = document.getElementById('loadingMessage');
        const statusMessage = document.getElementById('statusMessage');
        const resetEmailEl = document.getElementById('resetEmail');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const resetSubmitButton = document.getElementById('resetSubmitButton');

        let actionCode = null; // To store the code from URL

        // --- Helper Functions (Copied/Adapted from auth.html) ---
        function isValidPassword(password) {
            // Re-using your exact validation logic
            return password.length >= 8 &&
                   /[A-Z]/.test(password) &&
                   /[a-z]/.test(password) &&
                   /\d/.test(password) &&
                   /[!@#$%^&*(),.?":{}|<>]/.test(password) &&
                   !/\s/.test(password);
        }

        function validatePassword() { // Function to update requirement indicators
            const password = newPasswordInput.value;
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
                nospace: !/\s/.test(password) && password.length > 0 // Ensure no space check works even on empty
            };
            Object.keys(requirements).forEach(req => {
                const element = document.getElementById(`req-${req}`);
                if (element) { // Check if element exists
                    if (requirements[req]) {
                        element.className = 'requirement valid';
                        element.textContent = element.textContent.replace('✗', '✓');
                    } else {
                        element.className = 'requirement invalid';
                        element.textContent = element.textContent.replace('✓', '✗');
                    }
                }
            });
             return isValidPassword(password); // Return overall validity
        }
        window.validatePassword = validatePassword; // Make accessible to oninput

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = message;
        }

        function clearErrors(errorIds) {
            errorIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = '';
            });
        }

        function setLoadingState(button, isLoading) {
             const text = button.querySelector('.btn-text');
             const spinner = button.querySelector('.btn-spinner');
             if (!text || !spinner) return;
             button.disabled = isLoading;
             text.style.display = isLoading ? 'none' : 'inline';
             spinner.style.display = isLoading ? 'inline' : 'none';
        }

        function showStatus(message, isError = false) {
             statusMessage.textContent = message;
             statusMessage.className = `status-message ${isError ? 'error' : 'success'}`;
             statusMessage.style.display = 'block';
        }

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Get Action Code from URL
            const urlParams = new URLSearchParams(window.location.search);
            actionCode = urlParams.get('oobCode'); // Firebase uses 'oobCode'

            if (!actionCode) {
                loadingMessage.textContent = 'Invalid request. No action code found.';
                showStatus('Could not process request. Please try the password reset link again.', true);
                return;
            }

            // 2. Verify Action Code
            try {
                const email = await verifyPasswordResetCode(auth, actionCode);
                // Code is valid, show the form
                resetEmailEl.textContent = email;
                loadingMessage.style.display = 'none';
                resetPasswordForm.style.display = 'grid'; // Use grid like your other forms
                showStatus('Please enter and confirm your new password.', false);

            } catch (error) {
                // Code is invalid or expired
                console.error("Error verifying password reset code:", error);
                loadingMessage.style.display = 'none';
                let errorMessage = 'Invalid or expired password reset link. Please request a new one.';
                if (error.code === 'auth/expired-action-code') {
                    errorMessage = 'This password reset link has expired. Please request a new one.';
                } else if (error.code === 'auth/invalid-action-code') {
                    errorMessage = 'This password reset link is invalid. Please request a new one.';
                } else if (error.code === 'auth/user-disabled') {
                    errorMessage = 'Your account has been disabled.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found for this reset link.';
                }
                showStatus(errorMessage, true);
            }
        });

        // 3. Handle Form Submission
        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors(['newPassword-error', 'confirmPassword-error']);
            statusMessage.style.display = 'none'; // Hide previous status

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Client-side validation
            let hasErrors = false;
            if (newPassword !== confirmPassword) {
                showError('confirmPassword-error', 'Passwords do not match.');
                hasErrors = true;
            }
             // Use your custom validation
            if (!isValidPassword(newPassword)) {
                 // The validatePassword() function called via oninput already updates UI indicators
                showError('newPassword-error', 'Password does not meet requirements.');
                hasErrors = true;
            }

            if (hasErrors) return;

            // Attempt to confirm the reset with Firebase
            setLoadingState(resetSubmitButton, true);
            try {
                await confirmPasswordReset(auth, actionCode, newPassword);
                // Success!
                resetPasswordForm.style.display = 'none'; // Hide form
                showStatus('Password successfully reset! You can now log in with your new password.', false);
                // Optionally redirect after a delay:
                // setTimeout(() => { window.location.href = 'auth.html'; }, 3000);

            } catch (error) {
                // Handle Firebase errors (e.g., weak-password if Firebase enforces, expired code again)
                console.error("Error confirming password reset:", error);
                let errorMessage = 'Failed to reset password. Please try again.';
                 if (error.code === 'auth/weak-password') {
                     errorMessage = 'The new password is too weak. Please choose a stronger one.';
                     showError('newPassword-error', errorMessage);
                 } else if (error.code === 'auth/expired-action-code' || error.code === 'auth/invalid-action-code') {
                     errorMessage = 'This password reset link is no longer valid. Please request a new one.';
                     showStatus(errorMessage, true);
                     resetPasswordForm.style.display = 'none'; // Hide form if code is invalid
                 } else {
                     showStatus(errorMessage, true);
                 }
            } finally {
                setLoadingState(resetSubmitButton, false);
            }
        });

    </script>
</body>
</html>