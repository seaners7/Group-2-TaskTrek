<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Account Action</title> {/* Changed Title */}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <style>
        .status-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .status-message.success { background-color: rgba(34, 197, 94, 0.2); border: 1px solid var(--success); color: var(--success);}
        .status-message.error { background-color: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger); color: var(--danger);}
    </style>
</head>
<body>
    <main class="auth">
        <a class="auth__back" href="auth.html">← Back to Login</a>

        <div class="auth__card">
            <div class="auth__brand">
                <span class="logo-dot"></span>
                <span class="brand-text">TaskTrek</span>
            </div>
            <h3 id="actionTitle">Processing Request...</h3> {/* Dynamic Title */}

            {/* Status Message Area */}
            <div id="statusMessage" class="status-message" style="display: none;"></div>

            {/* --- Password Reset Form (Initially Hidden) --- */}
            <form id="resetPasswordForm" style="display: none;">
                <p>Please enter your new password for <strong id="resetEmail">your email</strong>.</p>

                <div class="form-field">
                    <label for="newPassword">New Password</label>
                    <input class="input" type="password" id="newPassword" placeholder="Create a new password" required oninput="validatePassword()" />
                    <div class="password-requirements" id="password-requirements">
                        <div class="requirement invalid" id="req-length">✗ At least 8 characters</div>
                        <div class="requirement invalid" id="req-uppercase">✗ One uppercase letter</div>
                        <div class="requirement invalid" id="req-lowercase">✗ One lowercase letter</div>
                        <div class="requirement invalid" id="req-number">✗ One number</div>
                        <div class="requirement invalid" id="req-special">✗ One special character</div>
                        <div class="requirement invalid" id="req-nospace">✗ No spaces allowed</div>
                    </div>
                    <div class="error-message" id="newPassword-error"></div>
                </div>

                <div class="form-field">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input class="input" type="password" id="confirmPassword" placeholder="Confirm your new password" required />
                    <div class="error-message" id="confirmPassword-error"></div>
                </div>

                <div class="form-row" style="margin-top: 15px;">
                    <button class="btn btn--primary" type="submit" id="resetSubmitButton">
                        <span class="btn-text">Save New Password</span>
                        <span class="btn-spinner" style="display: none;">⏳</span>
                    </button>
                </div>
            </form>
            {/* --- End Password Reset Form --- */}

            {/* General Message Area (for verification, errors, etc.) */}
            <p id="infoMessage">Verifying your request...</p>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import {
            getAuth,
            verifyPasswordResetCode,
            confirmPasswordReset,
            applyActionCode // <-- ADDED for email verification
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        // --- Firebase Config (Keep yours) ---
        const firebaseConfig = { /* ... your config ... */ };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- UI Elements ---
        const actionTitle = document.getElementById('actionTitle');
        const resetPasswordForm = document.getElementById('resetPasswordForm');
        const infoMessage = document.getElementById('infoMessage');
        const statusMessage = document.getElementById('statusMessage');
        const resetEmailEl = document.getElementById('resetEmail');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const resetSubmitButton = document.getElementById('resetSubmitButton');

        let actionCode = null;
        let mode = null;

        // --- Helper Functions (Keep isValidPassword, validatePassword, showError, clearErrors, setLoadingState, showStatus) ---
        function isValidPassword(password) { /* ... keep existing ... */ }
        function validatePassword() { /* ... keep existing ... */ }
        window.validatePassword = validatePassword; // Make accessible
        function showError(elementId, message) { /* ... keep existing ... */ }
        function clearErrors(errorIds) { /* ... keep existing ... */ }
        function setLoadingState(button, isLoading) { /* ... keep existing ... */ }
        function showStatus(message, isError = false) { /* ... keep existing ... */ }

        // --- Main Logic ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Get Action Code and Mode from URL
            const urlParams = new URLSearchParams(window.location.search);
            actionCode = urlParams.get('oobCode');
            mode = urlParams.get('mode'); // 'resetPassword', 'verifyEmail', etc.

            if (!actionCode || !mode) {
                actionTitle.textContent = 'Invalid Request';
                infoMessage.textContent = 'Invalid or incomplete action link.';
                showStatus('Could not process request. Please try the link from your email again.', true);
                return;
            }

            infoMessage.textContent = 'Processing...'; // Update initial message

            // 2. Handle Action Based on Mode
            switch (mode) {
                case 'resetPassword':
                    actionTitle.textContent = 'Set New Password';
                    try {
                        const email = await verifyPasswordResetCode(auth, actionCode);
                        // Code is valid, show the form
                        resetEmailEl.textContent = email;
                        infoMessage.style.display = 'none'; // Hide initial message
                        resetPasswordForm.style.display = 'grid';
                        showStatus('Please enter and confirm your new password.', false);
                    } catch (error) {
                        // Code is invalid or expired
                        console.error("Error verifying password reset code:", error);
                        infoMessage.style.display = 'none'; // Hide initial message
                        let errorMessage = 'Invalid or expired password reset link. Please request a new one.';
                        // ... (keep existing specific error messages if desired) ...
                        showStatus(errorMessage, true);
                    }
                    break;

                case 'verifyEmail':
                    actionTitle.textContent = 'Verify Email Address';
                    try {
                        await applyActionCode(auth, actionCode);
                        // Email verified successfully
                        infoMessage.style.display = 'none'; // Hide initial message
                        showStatus('Email verified successfully! You can now log in.', false);
                        // Optional: Add a link back to login
                        // infoMessage.innerHTML = '<a href="auth.html" class="btn btn--primary">Proceed to Login</a>';
                        // infoMessage.style.display = 'block';

                    } catch (error) {
                        // Handle verification errors
                        console.error("Error applying action code for email verification:", error);
                        infoMessage.style.display = 'none'; // Hide initial message
                        let errorMessage = 'Failed to verify email. The link may be invalid or expired.';
                        // ... (add specific error checks if needed) ...
                        showStatus(errorMessage, true);
                    }
                    break;

                // case 'recoverEmail':
                //     // Handle email change recovery if you implement that feature
                //     actionTitle.textContent = 'Recover Email';
                //     // ... logic using checkActionCode and applyActionCode ...
                //     break;

                default:
                    actionTitle.textContent = 'Unknown Action';
                    infoMessage.textContent = 'The action requested is not recognized.';
                    showStatus('The link used is not valid for a known action.', true);
            }
        });

        // 3. Handle Password Reset Form Submission (Keep existing logic)
        resetPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearErrors(['newPassword-error', 'confirmPassword-error']);
            statusMessage.style.display = 'none'; // Hide previous status

            const newPassword = newPasswordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            // Client-side validation
            let hasErrors = false;
            if (newPassword !== confirmPassword) {
                showError('confirmPassword-error', 'Passwords do not match.');
                hasErrors = true;
            }
            if (!isValidPassword(newPassword)) { // Use your custom validation
                showError('newPassword-error', 'Password does not meet requirements.');
                hasErrors = true;
            }
            if (hasErrors) return;

            // Attempt to confirm the reset with Firebase
            setLoadingState(resetSubmitButton, true);
            try {
                await confirmPasswordReset(auth, actionCode, newPassword);
                // Success!
                resetPasswordForm.style.display = 'none'; // Hide form
                showStatus('Password successfully reset! You can now log in with your new password.', false);

            } catch (error) {
                // Handle Firebase errors
                console.error("Error confirming password reset:", error);
                let errorMessage = 'Failed to reset password. Please try again.';
                 if (error.code === 'auth/weak-password') {
                     errorMessage = 'The new password is too weak. Please choose a stronger one.';
                     showError('newPassword-error', errorMessage);
                 } else if (error.code === 'auth/expired-action-code' || error.code === 'auth/invalid-action-code') {
                     errorMessage = 'This password reset link is no longer valid. Please request a new one.';
                     showStatus(errorMessage, true);
                     resetPasswordForm.style.display = 'none'; // Hide form if code is invalid
                 } else {
                     showStatus(errorMessage, true);
                 }
            } finally {
                setLoadingState(resetSubmitButton, false);
            }
        });

    </script>
</body>
</html>