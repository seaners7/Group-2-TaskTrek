<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskTrek — Account Action</title> {/* Changed Title */}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css" />
    <style>
        .status-message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .status-message.success { background-color: rgba(34, 197, 94, 0.2); border: 1px solid var(--success); color: var(--success);}
        .status-message.error { background-color: rgba(239, 68, 68, 0.2); border: 1px solid var(--danger); color: var(--danger);}
    </style>
</head>
<body>
    <main class="auth">
        <a class="auth__back" href="auth.html">← Back to Login</a>

        <div class="auth__card">
            <div class="auth__brand">
                <span class="logo-dot"></span>
                <span class="brand-text">TaskTrek</span>
            </div>
            <h3 id="actionTitle">Processing Request...</h3> {/* Dynamic Title */}

            {/* Status Message Area */}
            <div id="statusMessage" class="status-message" style="display: none;"></div>

            {/* --- Password Reset Form (Initially Hidden) --- */}
            <form id="resetPasswordForm" style="display: none;">
                <p>Please enter your new password for <strong id="resetEmail">your email</strong>.</p>

                <div class="form-field">
                    <label for="newPassword">New Password</label>
                    <input class="input" type="password" id="newPassword" placeholder="Create a new password" required oninput="validatePassword()" />
                    <div class="password-requirements" id="password-requirements">
                        <div class="requirement invalid" id="req-length">✗ At least 8 characters</div>
                        <div class="requirement invalid" id="req-uppercase">✗ One uppercase letter</div>
                        <div class="requirement invalid" id="req-lowercase">✗ One lowercase letter</div>
                        <div class="requirement invalid" id="req-number">✗ One number</div>
                        <div class="requirement invalid" id="req-special">✗ One special character</div>
                        <div class="requirement invalid" id="req-nospace">✗ No spaces allowed</div>
                    </div>
                    <div class="error-message" id="newPassword-error"></div>
                </div>

                <div class="form-field">
                    <label for="confirmPassword">Confirm New Password</label>
                    <input class="input" type="password" id="confirmPassword" placeholder="Confirm your new password" required />
                    <div class="error-message" id="confirmPassword-error"></div>
                </div>

                <div class="form-row" style="margin-top: 15px;">
                    <button class="btn btn--primary" type="submit" id="resetSubmitButton">
                        <span class="btn-text">Save New Password</span>
                        <span class="btn-spinner" style="display: none;">⏳</span>
                    </button>
                </div>
            </form>
            {/* --- End Password Reset Form --- */}

            {/* General Message Area (for verification, errors, etc.) */}
            <p id="infoMessage">Verifying your request...</p>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import {
            getAuth,
            verifyPasswordResetCode,
            confirmPasswordReset,
            applyActionCode // <-- ADDED for email verification
        } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        // --- Firebase Config (Keep yours) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCVZmortwiPrLezWCxQo53u60b4-IGgeWw", 
            authDomain: "tasktrek-e7a04.firebaseapp.com",
    projectId: "tasktrek-e7a04",
    storageBucket: "tasktrek-e7a04.firebasestorage.app",
    messagingSenderId: "900463967783",
    appId: "1:900463967783:web:9dc9485517aa908fbdd802",
    measurementId: "G-6BCT9FME3V"
         };// --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // --- UI Elements ---
    const actionTitle = document.getElementById('actionTitle');
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const infoMessage = document.getElementById('infoMessage');
    const statusMessage = document.getElementById('statusMessage');
    const resetEmailEl = document.getElementById('resetEmail');
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const resetSubmitButton = document.getElementById('resetSubmitButton');

    let actionCode = null;
    let mode = null;

    // --- Helper Functions (Copied from auth.html) ---

    // Checks if a password meets all defined criteria
    function isValidPassword(password) {
        return password.length >= 8 &&
               /[A-Z]/.test(password) &&
               /[a-z]/.test(password) &&
               /\d/.test(password) &&
               /[!@#$%^&*(),.?":{}|<>]/.test(password) &&
               !/\s/.test(password);
    }

    // Updates the UI indicators for password requirements
    function validatePassword() {
        // Use newPasswordInput since that's the ID on this page
        const password = newPasswordInput.value;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password),
            special: /[!@#$%^&*(),.?":{}|<>]/.test(password),
            nospace: !/\s/.test(password) && password.length > 0 // Check space only if > 0 length
        };
        // Update UI elements based on requirements check
        Object.keys(requirements).forEach(req => {
            const element = document.getElementById(`req-${req}`);
            if (element) { // Check if element exists before modifying
                if (requirements[req]) {
                    element.className = 'requirement valid';
                    element.textContent = element.textContent.replace('✗', '✓');
                } else {
                    element.className = 'requirement invalid';
                    element.textContent = element.textContent.replace('✓', '✗');
                }
            }
        });
        return isValidPassword(password); // Return overall validity
    }
    // Expose validatePassword globally for the oninput attribute in HTML
    window.validatePassword = validatePassword;

    // Displays an error message below a specific form field
    function showError(elementId, message) {
        const el = document.getElementById(elementId);
        if (el) el.textContent = message;
    }

    // Clears error messages for a list of element IDs
    function clearErrors(errorIds) {
        errorIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '';
        });
    }

    // Toggles button loading state (disables button, shows/hides text/spinner)
    function setLoadingState(button, isLoading) {
        const text = button.querySelector('.btn-text');
        const spinner = button.querySelector('.btn-spinner');
        // If button doesn't have spinner structure, just disable/enable
        if (!text || !spinner) {
             button.disabled = isLoading;
             return;
        }
        button.disabled = isLoading;
        text.style.display = isLoading ? 'none' : 'inline';
        spinner.style.display = isLoading ? 'inline' : 'none';
    }

    // Displays a general status message (success or error)
    function showStatus(message, isError = false) {
         statusMessage.textContent = message;
         statusMessage.className = `status-message ${isError ? 'error' : 'success'}`;
         statusMessage.style.display = 'block';
    }

    // --- Main Logic (Handles URL parameters and actions) ---
    document.addEventListener('DOMContentLoaded', async () => {
        // 1. Get Action Code and Mode from URL
        const urlParams = new URLSearchParams(window.location.search);
        actionCode = urlParams.get('oobCode');
        mode = urlParams.get('mode');

        if (!actionCode || !mode) {
            actionTitle.textContent = 'Invalid Request';
            infoMessage.textContent = 'Invalid or incomplete action link.';
            showStatus('Could not process request. Please try the link from your email again.', true);
            return;
        }

        infoMessage.textContent = 'Processing...';

        // 2. Handle Action Based on Mode
        switch (mode) {
            case 'resetPassword':
                actionTitle.textContent = 'Set New Password';
                try {
                    const email = await verifyPasswordResetCode(auth, actionCode);
                    resetEmailEl.textContent = email;
                    infoMessage.style.display = 'none';
                    resetPasswordForm.style.display = 'grid'; // Show form
                    showStatus('Please enter and confirm your new password.', false);
                } catch (error) {
                    console.error("Error verifying password reset code:", error);
                    infoMessage.style.display = 'none';
                    let errorMessage = 'Invalid or expired password reset link. Please request a new one.';
                    if (error.code === 'auth/expired-action-code') errorMessage = 'This password reset link has expired.';
                    else if (error.code === 'auth/invalid-action-code') errorMessage = 'This password reset link is invalid.';
                    else if (error.code === 'auth/user-disabled') errorMessage = 'Your account has been disabled.';
                    else if (error.code === 'auth/user-not-found') errorMessage = 'No account found for this reset link.';
                    showStatus(errorMessage, true);
                }
                break;

            case 'verifyEmail':
                actionTitle.textContent = 'Verify Email Address';
                try {
                    await applyActionCode(auth, actionCode);
                    infoMessage.style.display = 'none';
                    showStatus('Email verified successfully! You can now log in.', false);
                    // Add a login link below the status message
                    infoMessage.innerHTML = '<a href="auth.html" class="btn btn--primary" style="margin-top: 15px;">Proceed to Login</a>';
                    infoMessage.style.display = 'block';
                } catch (error) {
                    console.error("Error applying action code for email verification:", error);
                    infoMessage.style.display = 'none';
                    let errorMessage = 'Failed to verify email. The link may be invalid, expired, or the email may already be verified.';
                    if (error.code === 'auth/expired-action-code') errorMessage = 'This verification link has expired.';
                    else if (error.code === 'auth/invalid-action-code') errorMessage = 'This verification link is invalid.';
                    else if (error.code === 'auth/user-disabled') errorMessage = 'Your account has been disabled.';
                    else if (error.code === 'auth/user-not-found') errorMessage = 'No account found for this verification link.';
                    showStatus(errorMessage, true);
                }
                break;

            default:
                actionTitle.textContent = 'Unknown Action';
                infoMessage.textContent = 'The action requested is not recognized.';
                showStatus('The link used is not valid for a known action.', true);
        }
    });

    // 3. Handle Password Reset Form Submission
    resetPasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearErrors(['newPassword-error', 'confirmPassword-error']);
        statusMessage.style.display = 'none';

        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        let hasErrors = false;
        if (newPassword !== confirmPassword) {
            showError('confirmPassword-error', 'Passwords do not match.');
            hasErrors = true;
        }
        // Use your custom validation function
        if (!isValidPassword(newPassword)) {
            // UI indicators are updated by oninput="validatePassword()"
            showError('newPassword-error', 'Password does not meet requirements.');
            hasErrors = true;
        }
        if (hasErrors) return;

        setLoadingState(resetSubmitButton, true);
        try {
            await confirmPasswordReset(auth, actionCode, newPassword);
            resetPasswordForm.style.display = 'none';
            showStatus('Password successfully reset! You can now log in with your new password.', false);
             // Add a login link below the status message
             infoMessage.innerHTML = '<a href="auth.html" class="btn btn--primary" style="margin-top: 15px;">Proceed to Login</a>';
             infoMessage.style.display = 'block';

        } catch (error) {
            console.error("Error confirming password reset:", error);
            let errorMessage = 'Failed to reset password. Please try again.';
             if (error.code === 'auth/weak-password') {
                 errorMessage = 'The new password is too weak according to Firebase standards.'; // More specific Firebase message
                 showError('newPassword-error', errorMessage);
             } else if (error.code === 'auth/expired-action-code' || error.code === 'auth/invalid-action-code') {
                 errorMessage = 'This password reset link is no longer valid. Please request a new one.';
                 showStatus(errorMessage, true);
                 resetPasswordForm.style.display = 'none'; // Hide form if code is invalid
             } else {
                 showStatus(errorMessage, true);
             }
        } finally {
            setLoadingState(resetSubmitButton, false);
        }
    });

</script>
</body>
</html>